!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Tinode=t()}}((function(){var t={exports:{}};const e=function(t){t&&(this.given="number"==typeof t.given?t.given:e.decode(t.given),this.want="number"==typeof t.want?t.want:e.decode(t.want),this.mode=t.mode?"number"==typeof t.mode?t.mode:e.decode(t.mode):this.given&this.want)};e._NONE=0,e._JOIN=1,e._READ=2,e._WRITE=4,e._PRES=8,e._APPROVE=16,e._SHARE=32,e._DELETE=64,e._OWNER=128,e._BITMASK=e._JOIN|e._READ|e._WRITE|e._PRES|e._APPROVE|e._SHARE|e._DELETE|e._OWNER,e._INVALID=1048576,e._checkFlag=function(t,e,n){if(["given","want","mode"].includes(e=e||"mode"))return 0!=(t[e]&n);throw new Error("Invalid AccessMode component '".concat(e,"'"))},e.decode=function(t){if(!t)return null;if("number"==typeof t)return t&e._BITMASK;if("N"===t||"n"===t)return e._NONE;const n={J:e._JOIN,R:e._READ,W:e._WRITE,P:e._PRES,A:e._APPROVE,S:e._SHARE,D:e._DELETE,O:e._OWNER};let s=e._NONE;for(let e=0;e<t.length;e++){const i=n[t.charAt(e).toUpperCase()];i&&(s|=i)}return s},e.encode=function(t){if(null===t||t===e._INVALID)return null;if(t===e._NONE)return"N";const n=["J","R","W","P","A","S","D","O"];let s="";for(let e=0;e<n.length;e++)0!=(t&1<<e)&&(s+=n[e]);return s},e.update=function(t,n){if(!n||"string"!=typeof n)return t;let s=n.charAt(0);if("+"==s||"-"==s){let i=t;const r=n.split(/([-+])/);for(let n=1;n<r.length-1;n+=2){s=r[n];const o=e.decode(r[n+1]);if(o==e._INVALID)return t;null!=o&&("+"===s?i|=o:"-"===s&&(i&=~o))}t=i}else{const s=e.decode(n);s!=e._INVALID&&(t=s)}return t},e.diff=function(t,n){return t=e.decode(t),n=e.decode(n),t==e._INVALID||n==e._INVALID?e._INVALID:t&~n},e.prototype={toString:function(){return'{"mode": "'+e.encode(this.mode)+'", "given": "'+e.encode(this.given)+'", "want": "'+e.encode(this.want)+'"}'},jsonHelper:function(){return{mode:e.encode(this.mode),given:e.encode(this.given),want:e.encode(this.want)}},setMode:function(t){return this.mode=e.decode(t),this},updateMode:function(t){return this.mode=e.update(this.mode,t),this},getMode:function(){return e.encode(this.mode)},setGiven:function(t){return this.given=e.decode(t),this},updateGiven:function(t){return this.given=e.update(this.given,t),this},getGiven:function(){return e.encode(this.given)},setWant:function(t){return this.want=e.decode(t),this},updateWant:function(t){return this.want=e.update(this.want,t),this},getWant:function(){return e.encode(this.want)},getMissing:function(){return e.encode(this.want&~this.given)},getExcessive:function(){return e.encode(this.given&~this.want)},updateAll:function(t){return t&&(this.updateGiven(t.given),this.updateWant(t.want),this.mode=this.given&this.want),this},isOwner:function(t){return e._checkFlag(this,t,e._OWNER)},isPresencer:function(t){return e._checkFlag(this,t,e._PRES)},isMuted:function(t){return!this.isPresencer(t)},isJoiner:function(t){return e._checkFlag(this,t,e._JOIN)},isReader:function(t){return e._checkFlag(this,t,e._READ)},isWriter:function(t){return e._checkFlag(this,t,e._WRITE)},isApprover:function(t){return e._checkFlag(this,t,e._APPROVE)},isAdmin:function(t){return this.isOwner(t)||this.isApprover(t)},isSharer:function(t){return this.isAdmin(t)||e._checkFlag(this,t,e._SHARE)},isDeleter:function(t){return e._checkFlag(this,t,e._DELETE)}},t.exports=e,t=t.exports;var n={exports:{}};n.exports=function(t,e){let n=[];function s(e,n,s){let i=0,r=n.length-1,o=0,a=0,c=!1;for(;i<=r;)if((a=t(n[o=(i+r)/2|0],e))<0)i=o+1;else{if(!(a>0)){c=!0;break}r=o-1}return c?{idx:o,exact:!0}:s?{idx:-1}:{idx:a<0?o+1:o}}function i(t,n){const i=s(t,n,!1),r=i.exact&&e?1:0;return n.splice(i.idx,r,t),n}return t=t||function(t,e){return t===e?0:t<e?-1:1},{getAt:function(t){return n[t]},getLast:function(t){return t|=0,n.length>t?n[n.length-1-t]:void 0},put:function(){let t;t=1==arguments.length&&Array.isArray(arguments[0])?arguments[0]:arguments;for(let e in t)i(t[e],n)},delAt:function(t){t|=0;let e=n.splice(t,1);if(e&&e.length>0)return e[0]},delRange:function(t,e){return n.splice(t,e-t)},length:function(){return n.length},reset:function(){n=[]},forEach:function(t,e,s,i){e|=0,s=s||n.length;for(let r=e;r<s;r++)t.call(i,n[r],r>e?n[r-1]:void 0,r<s-1?n[r+1]:void 0,r)},find:function(t,e){const{idx:i}=s(t,n,!e);return i},filter:function(t,e){let s=0;for(let i=0;i<n.length;i++)t.call(e,n[i],i)&&(n[s]=n[i],s++);n.splice(s)}}},n=n.exports;var s={exports:{}};s.exports={jsonParseHelper:function(e,n){if("string"==typeof n&&n.length>=20&&n.length<=24&&["ts","touched","updated","created","when","deleted","expires"].includes(e)){const t=new Date(n);if(!isNaN(t))return t}else if("acs"===e&&"object"==typeof n)return new t(n);return n},isUrlRelative:function(t){return t&&!/^\s*([a-z][a-z0-9+.-]*:|\/\/)/im.test(t)}},s=s.exports;var i={exports:{}};const{jsonParseHelper:r}=s;let o,a;function c(t,e,n,s){let i=null;return["http","https","ws","wss"].includes(e)&&("/"!==(i="".concat(e,"://").concat(t)).charAt(i.length-1)&&(i+="/"),i+="v"+n+"/channels",["http","https"].includes(e)&&(i+="/lp"),i+="?apikey="+s),i}const u=function(t,e,n){let s=t.host;const i=t.secure,h=t.apiKey,l=e,d=n;let f=null,p=0,g=!1;const m=function(t){if(u.logger){for(var e=arguments.length,n=new Array(e>1?e-1:0),s=1;s<e;s++)n[s-1]=arguments[s];u.logger(t,...n)}};function _(){clearTimeout(f);const t=Math.pow(2,p)*(1+.3*Math.random())*2e3;p=p>=10?p:p+1,this.onAutoreconnectIteration&&this.onAutoreconnectIteration(t),f=setTimeout(()=>{if(m("Reconnecting, iter=".concat(p,", timeout=").concat(t)),g)this.onAutoreconnectIteration&&this.onAutoreconnectIteration(-1);else{const t=this.connect();this.onAutoreconnectIteration?this.onAutoreconnectIteration(0,t):t.catch(()=>{})}},t)}function b(){clearTimeout(f),f=null}let w=!1;if("lp"===t.transport?(function(t){let e=null,n=null,o=null;t.connect=function(o,u){if(g=!1,n){if(!u)return Promise.resolve();n.onreadystatechange=void 0,n.abort(),n=null}return o&&(s=o),new Promise((function(o,u){const f=c(s,i?"https":"http",l,h);m("Connecting to:",f),(n=function n(s,i,o){let c=new a,u=!1;return c.onreadystatechange=function(a){if(4==c.readyState)if(201==c.status){let o=JSON.parse(c.responseText,r);e=s+"&sid="+o.ctrl.params.sid,(c=n(e)).send(null),t.onOpen&&t.onOpen(),i&&(u=!0,i()),d&&b()}else if(c.status<400)t.onMessage&&t.onMessage(c.responseText),(c=n(e)).send(null);else{if(o&&!u&&(u=!0,o(c.responseText)),t.onMessage&&c.responseText&&t.onMessage(c.responseText),t.onDisconnect){const e=c.status||(g?418:503),n=c.responseText||(g?"Disconnected by client":"Connection failed");t.onDisconnect(new Error(n+" ("+e+")"),e)}c=null,!g&&d&&_.call(t)}},c.open("GET",s,!0),c}(f,o,u)).send(null)})).catch(t=>{m("LP connection failed:",t)})},t.reconnect=function(e){b(),t.connect(null,e)},t.disconnect=function(){g=!0,b(),o&&(o.onreadystatechange=void 0,o.abort(),o=null),n&&(n.onreadystatechange=void 0,n.abort(),n=null),t.onDisconnect&&t.onDisconnect(new Error("Disconnected by client (418)"),418),e=null},t.sendText=function(t){if(!(o=function(t){const e=new a;return e.onreadystatechange=function(t){if(4==e.readyState&&e.status>=400)throw new Error("LP sender failed, ".concat(e.status))},e.open("POST",t,!0),e}(e))||1!=o.readyState)throw new Error("Long poller failed to connect");o.send(t)},t.isConnected=function(){return n&&!0},t.transport=function(){return"lp"},t.probe=function(){t.sendText("1")}}(this),w=!0):"ws"===t.transport&&(function(t){let e=null;t.connect=function(n,r){if(g=!1,e){if(!r&&e.readyState==e.OPEN)return Promise.resolve();e.close(),e=null}return n&&(s=n),new Promise((function(n,r){const a=c(s,i?"wss":"ws",l,h);m("Connecting to: ",a);const u=new o(a);u.onerror=function(t){r(t)},u.onopen=function(e){d&&b(),t.onOpen&&t.onOpen(),n()},u.onclose=function(n){if(e=null,t.onDisconnect){const e=g?418:503;t.onDisconnect(new Error(g?"Disconnected by client":"Connection failed ("+e+")"),e)}!g&&d&&_.call(t)},u.onmessage=function(e){t.onMessage&&t.onMessage(e.data)},e=u}))},t.reconnect=function(e){b(),t.connect(null,e)},t.disconnect=function(){g=!0,b(),e&&(e.close(),e=null)},t.sendText=function(t){if(!e||e.readyState!=e.OPEN)throw new Error("Websocket is not connected");e.send(t)},t.isConnected=function(){return e&&e.readyState==e.OPEN},t.transport=function(){return"ws"},t.probe=function(){t.sendText("1")}}(this),w=!0),!w)throw m("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'."),new Error("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'.");this.backoffReset=function(){p=0},this.onMessage=void 0,this.onDisconnect=void 0,this.onOpen=void 0,this.onAutoreconnectIteration=void 0,this.logger=void 0};u.setNetworkProviders=function(t,e){o=t,a=e},u.NETWORK_ERROR=503,u.NETWORK_ERROR_TEXT="Connection failed",u.NETWORK_USER=418,u.NETWORK_USER_TEXT="Disconnected by client",i.exports=u,i=i.exports;var h={exports:{}};let l;const d=function(t,e){t=t||function(){},e=e||function(){};let n=null,s=!1;const i=["created","updated","deleted","read","recv","seq","clear","defacs","creds","public","trusted","private","touched"];function r(t,e){const n=t||{};return["topic","seq","ts","_status","from","head","content"].forEach(t=>{e.hasOwnProperty(t)&&(n[t]=e[t])}),n}function o(t,i,r){return n?new Promise((s,o)=>{const a=n.transaction([t]);a.onerror=n=>{e("PCache","mapObjects",t,n.target.error),o(n.target.error)},a.objectStore(t).getAll().onsuccess=t=>{i&&t.target.result.forEach(t=>{i.call(r,t)}),s(t.target.result)}}):s?Promise.resolve([]):Promise.reject(new Error("not initialized"))}return{initDatabase:function(){return new Promise((i,r)=>{const o=l.open("tinode-web",1);o.onsuccess=t=>{n=t.target.result,s=!1,i(n)},o.onerror=n=>{e("PCache","failed to initialize",n),r(n.target.error),t(n.target.error)},o.onupgradeneeded=function(s){(n=s.target.result).onerror=function(n){e("PCache","failed to create storage",n),t(n.target.error)},n.createObjectStore("topic",{keyPath:"name"}),n.createObjectStore("user",{keyPath:"uid"}),n.createObjectStore("subscription",{keyPath:["topic","uid"]}),n.createObjectStore("message",{keyPath:["topic","seq"]})}})},deleteDatabase:function(){return new Promise((t,i)=>{const r=l.deleteDatabase("tinode-web");r.onblocked=function(t){n&&n.close()},r.onsuccess=e=>{n=null,s=!0,t(!0)},r.onerror=t=>{e("PCache","deleteDatabase",t.target.error),i(t.target.error)}})},isReady:function(){return!!n},updTopic:function(t){return this.isReady()?new Promise((s,r)=>{const o=n.transaction(["topic"],"readwrite");o.oncomplete=t=>{s(t.target.result)},o.onerror=t=>{e("PCache","updTopic",t.target.error),r(t.target.error)};const a=o.objectStore("topic").get(t.name);a.onsuccess=e=>{o.objectStore("topic").put(function(t,e){const n=t||{name:e.name};return i.forEach(t=>{e.hasOwnProperty(t)&&(n[t]=e[t])}),Array.isArray(e._tags)&&(n.tags=e._tags),e.acs&&(n.acs=e.getAccessMode().jsonHelper()),n}(a.result,t)),o.commit()}}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},remTopic:function(t){return this.isReady()?new Promise((s,i)=>{const r=n.transaction(["topic","subscription","message"],"readwrite");r.oncomplete=t=>{s(t.target.result)},r.onerror=t=>{e("PCache","remTopic",t.target.error),i(t.target.error)},r.objectStore("topic").delete(IDBKeyRange.only(t)),r.objectStore("subscription").delete(IDBKeyRange.bound([t,"-"],[t,"~"])),r.objectStore("message").delete(IDBKeyRange.bound([t,0],[t,Number.MAX_SAFE_INTEGER])),r.commit()}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},mapTopics:function(t,e){return o("topic",t,e)},deserializeTopic:function(t,e){!function(t,e){i.forEach(n=>{e.hasOwnProperty(n)&&(t[n]=e[n])}),Array.isArray(e.tags)&&(t._tags=e.tags),e.acs&&t.setAccessMode(e.acs),t.seq|=0,t.read|=0,t.unread=Math.max(0,t.seq-t.read)}(t,e)},updUser:function(t,i){if(!(arguments.length<2||void 0===i))return this.isReady()?new Promise((s,r)=>{const o=n.transaction(["user"],"readwrite");o.oncomplete=t=>{s(t.target.result)},o.onerror=t=>{e("PCache","updUser",t.target.error),r(t.target.error)},o.objectStore("user").put({uid:t,public:i}),o.commit()}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},remUser:function(t){return this.isReady()?new Promise((s,i)=>{const r=n.transaction(["user"],"readwrite");r.oncomplete=t=>{s(t.target.result)},r.onerror=t=>{e("PCache","remUser",t.target.error),i(t.target.error)},r.objectStore("user").delete(IDBKeyRange.only(t)),r.commit()}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},mapUsers:function(t,e){return o("user",t,e)},getUser:function(t){return this.isReady()?new Promise((s,i)=>{const r=n.transaction(["user"]);r.oncomplete=t=>{const e=t.target.result;s({user:e.uid,public:e.public})},r.onerror=t=>{e("PCache","getUser",t.target.error),i(t.target.error)},r.objectStore("user").get(t)}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},updSubscription:function(t,i,r){return this.isReady()?new Promise((s,o)=>{const a=n.transaction(["subscription"],"readwrite");a.oncomplete=t=>{s(t.target.result)},a.onerror=t=>{e("PCache","updSubscription",t.target.error),o(t.target.error)},a.objectStore("subscription").get([t,i]).onsuccess=e=>{a.objectStore("subscription").put(function(t,e,n,s){const i=t||{topic:e,uid:n};return["updated","mode","read","recv","clear","lastSeen","userAgent"].forEach(t=>{s.hasOwnProperty(t)&&(i[t]=s[t])}),i}(e.target.result,t,i,r)),a.commit()}}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},mapSubscriptions:function(t,i,r){return this.isReady()?new Promise((s,o)=>{const a=n.transaction(["subscription"]);a.onerror=t=>{e("PCache","mapSubscriptions",t.target.error),o(t.target.error)},a.objectStore("subscription").getAll(IDBKeyRange.bound([t,"-"],[t,"~"])).onsuccess=t=>{i&&t.target.result.forEach(t=>{i.call(r,t)}),s(t.target.result)}}):s?Promise.resolve([]):Promise.reject(new Error("not initialized"))},addMessage:function(t){return this.isReady()?new Promise((s,i)=>{const o=n.transaction(["message"],"readwrite");o.onsuccess=t=>{s(t.target.result)},o.onerror=t=>{e("PCache","addMessage",t.target.error),i(t.target.error)},o.objectStore("message").add(r(null,t)),o.commit()}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},updMessageStatus:function(t,i,o){return this.isReady()?new Promise((s,a)=>{const c=n.transaction(["message"],"readwrite");c.onsuccess=t=>{s(t.target.result)},c.onerror=t=>{e("PCache","updMessageStatus",t.target.error),a(t.target.error)};const u=c.objectStore("message").get(IDBKeyRange.only([t,i]));u.onsuccess=e=>{const n=u.result||e.target.result;n&&n._status!=o?(c.objectStore("message").put(r(n,{topic:t,seq:i,_status:o})),c.commit()):c.commit()}}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},remMessages:function(t,i,r){return this.isReady()?new Promise((s,o)=>{i||r||(i=0,r=Number.MAX_SAFE_INTEGER);const a=r>0?IDBKeyRange.bound([t,i],[t,r],!1,!0):IDBKeyRange.only([t,i]),c=n.transaction(["message"],"readwrite");c.onsuccess=t=>{s(t.target.result)},c.onerror=t=>{e("PCache","remMessages",t.target.error),o(t.target.error)},c.objectStore("message").delete(a),c.commit()}):s?Promise.resolve():Promise.reject(new Error("not initialized"))},readMessages:function(t,i,r,o){return this.isReady()?new Promise((s,a)=>{const c=(i=i||{}).since>0?i.since:0,u=i.before>0?i.before:Number.MAX_SAFE_INTEGER,h=0|i.limit,l=[],d=IDBKeyRange.bound([t,c],[t,u],!1,!0),f=n.transaction(["message"]);f.onerror=t=>{e("PCache","readMessages",t.target.error),a(t.target.error)},f.objectStore("message").openCursor(d,"prev").onsuccess=t=>{const e=t.target.result;e?(r&&r.call(o,e.value),l.push(e.value),h<=0||l.length<h?e.continue():s(l)):s(l)}}):s?Promise.resolve([]):Promise.reject(new Error("not initialized"))}}};d.setDatabaseProvider=function(t){l=t},h.exports=d,h=h.exports;var f={exports:{}};const p=[{name:"ST",start:/(?:^|[\W_])(\*)[^\s*]/,end:/[^\s*](\*)(?=$|[\W_])/},{name:"EM",start:/(?:^|\W)(_)[^\s_]/,end:/[^\s_](_)(?=$|\W)/},{name:"DL",start:/(?:^|[\W_])(~)[^\s~]/,end:/[^\s~](~)(?=$|[\W_])/},{name:"CO",start:/(?:^|\W)(`)[^`]/,end:/[^`](`)(?=$|\W)/}],g=["QQ"],m=[{name:"LN",dataName:"url",pack:function(t){return/^[a-z]+:\/\//i.test(t)||(t="http://"+t),{url:t}},re:/(?:(?:https?|ftp):\/\/|www\.|ftp\.)[-A-Z0-9+&@#\/%=~_|$?!:,.]*[A-Z0-9+&@#\/%=~_|$]/gi},{name:"MN",dataName:"val",pack:function(t){return{val:t.slice(1)}},re:/\B@([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu},{name:"HT",dataName:"val",pack:function(t){return{val:t.slice(1)}},re:/\B#([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu}],_={BN:{name:"button",isVoid:!1},BR:{name:"br",isVoid:!0},CO:{name:"tt",isVoid:!1},DL:{name:"del",isVoid:!1},EM:{name:"i",isVoid:!1},EX:{name:"",isVoid:!0},FM:{name:"div",isVoid:!1},HD:{name:"",isVoid:!1},HL:{name:"span",isVoid:!1},HT:{name:"a",isVoid:!1},IM:{name:"img",isVoid:!1},LN:{name:"a",isVoid:!1},MN:{name:"a",isVoid:!1},RW:{name:"div",isVoid:!1},QQ:{name:"div",isVoid:!1},ST:{name:"b",isVoid:!1}};function b(t,e,n){if(!t)return null;try{const n=atob(t),s=n.length,i=new ArrayBuffer(s),r=new Uint8Array(i);for(let t=0;t<s;t++)r[t]=n.charCodeAt(t);return URL.createObjectURL(new Blob([i],{type:e}))}catch(s){n&&n("Drafty: failed to convert object.",s.message)}return null}function w(t,e){return t?"data:"+(e=e||"image/jpeg")+";base64,"+t:null}const v={ST:{open:function(){return"<b>"},close:function(){return"</b>"}},EM:{open:function(){return"<i>"},close:function(){return"</i>"}},DL:{open:function(){return"<del>"},close:function(){return"</del>"}},CO:{open:function(){return"<tt>"},close:function(){return"</tt>"}},BR:{open:function(){return"<br/>"},close:function(){return""}},HD:{open:function(){return""},close:function(){return""}},HL:{open:function(){return'<span style="color:teal">'},close:function(){return"</span>"}},LN:{open:function(t){return'<a href="'+t.url+'">'},close:function(t){return"</a>"},props:function(t){return t?{href:t.url,target:"_blank"}:null}},MN:{open:function(t){return'<a href="#'+t.val+'">'},close:function(t){return"</a>"},props:function(t){return t?{id:t.val}:null}},HT:{open:function(t){return'<a href="#'+t.val+'">'},close:function(t){return"</a>"},props:function(t){return t?{id:t.val}:null}},BN:{open:function(t){return"<button>"},close:function(t){return"</button>"},props:function(t){return t?{"data-act":t.act,"data-val":t.val,"data-name":t.name,"data-ref":t.ref}:null}},IM:{open:function(t){const e=w(t._tempPreview,t.mime),n=b(t.val,t.mime,y.logger),s=t.ref||n;return(t.name?'<a href="'+s+'" download="'+t.name+'">':"")+'<img src="'+(e||n)+'"'+(t.width?' width="'+t.width+'"':"")+(t.height?' height="'+t.height+'"':"")+' border="0" />'},close:function(t){return t.name?"</a>":""},props:function(t){return t?{src:w(t._tempPreview,t.mime)||t.ref||b(t.val,t.mime,y.logger),title:t.name,alt:t.name,"data-width":t.width,"data-height":t.height,"data-name":t.name,"data-size":t.val?.75*t.val.length|0:0|t.size,"data-mime":t.mime}:null}},FM:{open:function(t){return"<div>"},close:function(t){return"</div>"}},RW:{open:function(t){return"<div>"},close:function(t){return"</div>"}},QQ:{open:function(t){return"<div>"},close:function(t){return"</div>"},props:function(t){return t?{}:null}}},y=function(){this.txt="",this.fmt=[],this.ent=[]};function x(t,e,n,s){if("string"==typeof t&&(t={txt:t}),!y.isValid(t))return null;const i=M(t.txt,0,(t.txt||"").length,E(t),A,s),r=i&&i.length>0?{children:i}:null;return r&&n.call(e,r.sp,r.txt,r.children),e.drafty}function M(t,e,n,s,i,r){const o=[],a=[];for(let c=0;c<s.length;c++){const n=s[c];if(n.at<0){a.push(n);continue}e<n.at&&(o.push(i.call(r,null,void 0,t.slice(e,n.at),o.length)),e=n.at);const u=[];for(let t=c+1;t<s.length&&s[t].at<n.at+n.len;t++)u.push(s[t]),c=t;const h=_[n.tp]||{},l=r&&r.getFormatter?r.getFormatter(n.tp):null;o.push(i.call(r,n.tp,n.data,h.isVoid?null:M(t,e,n.at+n.len,u,l||i,r),o.length,n.key)),e=n.at+n.len}return e<n&&o.push(i.call(r,null,void 0,t.slice(e,n),o.length)),a.forEach(t=>{const e=i.call(r,t.tp,t.data,void 0,o.length,t.key);e&&o.push(e)}),o}function S(t){t="string"==typeof t?{txt:t}:t;let{txt:e,fmt:n,ent:s}=t;if(e=e||"",Array.isArray(s)||(s=[]),!Array.isArray(n)||0==n.length){if(0==s.length)return{text:e};n=[{at:0,len:0,key:0}]}const i=[],r=[];n.forEach(t=>{if(!["undefined","number"].includes(typeof t.at))return;if(!["undefined","number"].includes(typeof t.len))return;let n=0|t.at,o=0|t.len;if(o<0)return;let a=t.key||0;s.length>0&&("number"!=typeof a||a<0||a>=s.length)||(n<=-1?r.push({start:-1,end:0,key:a}):n+o>e.length||(t.tp?i.push({type:t.tp,start:n,end:n+o}):s.length>0&&"object"==typeof s[a]&&i.push({start:n,end:n+o,key:a})))}),i.sort((t,e)=>{let n=t.start-e.start;return 0!=n||0!=(n=e.end-t.end)?n:g.indexOf(e.type)-g.indexOf(t.type)}),r.length>0&&i.push(...r),i.forEach(t=>{s.length>0&&!t.type&&(t.type=s[t.key].tp,t.data=s[t.key].data),t.type||(t.type="HD")});let o=function t(e,n,s,i,r){if(!r||0==r.length)return s<i&&P(e,{text:n.substring(s,i)}),e;for(let o=0;o<r.length;o++){const i=r[o];if(i.start<0&&"EX"==i.type){P(e,{type:i.type,data:i.data,key:i.key,att:!0});continue}s<i.start&&(P(e,{text:n.substring(s,i.start)}),s=i.start);const a=[];for(;o<r.length-1;){const t=r[o+1];if(t.start<0)break;if(!(t.start<i.end))break;if(t.end<=i.end){const e=_[t.tp]||{};(t.start<t.end||e.isVoid)&&a.push(t)}o++}P(e,t({type:i.type,data:i.data,key:i.key},n,s,i.end,a)),s=i.end}return s<i&&P(e,{text:n.substring(s,i)}),e}({},e,0,e.length,i);return Array.isArray(o.children)&&1==o.children.length&&!o.type&&delete(o=o.children[0]).parent,o}function P(t,e){return e?(t.children||(t.children=[]),t.text&&(t.children.push({text:t.text,parent:t}),delete t.text),e.parent=t,t.children.push(e),t):t}function T(t,e,n){if(!e)return;t.txt=t.txt||"";const s=t.txt.length;if(e.text?t.txt+=e.text:Array.isArray(e.children)&&e.children.forEach(e=>{T(t,e,n)}),e.type){const i=t.txt.length-s;if(t.fmt=t.fmt||[],Object.keys(e.data||{}).length>0){t.ent=t.ent||[];const r=void 0===n[e.key]?t.ent.length:n[e.key];n[e.key]=r,t.ent[r]={tp:e.type,data:e.data},e.att?t.fmt.push({at:-1,len:0,key:r}):t.fmt.push({at:s,len:i,key:r})}else t.fmt.push({tp:e.type,at:s,len:i})}return t}function R(t,e,n){let s=e.call(n,t);if(!s||!s.children)return s;const i=[];for(let r in s.children){let t=s.children[r];t&&(t=R(t,e,n))&&i.push(t)}return 0==i.length?s.children=null:s.children=i,s}function E(t){let{txt:e,fmt:n,ent:s}=t;if(e=e||"",Array.isArray(s)||(s=[]),!Array.isArray(n)){if(1!=s.length)return[];n=[{at:0,len:0,key:0}]}const i=e.length;let r=[].concat(n);r.forEach(t=>{t.at=t.at||0,t.at<-1&&(t.at=-1,t.len=0),t.len=t.len||0,t.len<0||t.at>i?t.len=0:t.at+t.len>i&&(t.len=i-t.at)}),(r=r.map(t=>{let e,n=t.tp;return n||(t.key=t.key||0,s[t.key]&&(e=s[t.key].data,n=s[t.key].tp)),{tp:n=n||"HD",at:t.at,len:t.len,data:e,key:t.key}})).sort((t,e)=>{let n=t.at-e.at;return 0!=n||0!=(n=e.len-t.len)?n:g.indexOf(e.tp)-g.indexOf(t.tp)});let o=Number.MIN_SAFE_INTEGER;return r.filter(t=>!(t.at>i||t.at<o&&t.at+t.len>o||(o=Math.max(t.at+t.len,o),0)))}function A(t,e,n,s,i){const r={};return t&&(r.sp={tp:t},e&&(r.sp.data=e,r.sp.key=i)),"string"==typeof n?r.txt=n:Array.isArray(n)&&(r.children=n),r}function D(t,e){if(t&&Object.entries(t).length>0){const n={},s=["act","height","mime","name","ref","size","uid","url","width"];if(e||s.push("val"),s.forEach(e=>{t.hasOwnProperty(e)&&(n[e]=t[e])}),0!=Object.entries(n).length)return n}return null}function k(t,e){if(e.data){this.drafty.ent=this.drafty.ent||[];let n=this.keymap[e.key];if(void 0===n){const t={tp:e.tp},s=D(e.data,!1);s&&(t.data=s),n=this.drafty.ent.length,this.keymap[e.key]=n,this.drafty.ent.push(t)}t.key=n}else t.tp=e.tp;this.drafty.fmt=this.drafty.fmt||[],this.drafty.fmt.push(t)}function C(t,e,n){const s=this.drafty.txt.length;if(t&&0==s){if("EX"==t.tp)return void k.call(this,{at:-1},t);if("MN"==t.tp&&this.stripForwardedMention)return void(this.stripForwardedMention=!1);if("BR"==t.tp)return}n?n.forEach(t=>{C.call(this,t.sp,t.txt,t.children)}):e&&(this.drafty.txt+=e);const i=this.drafty.txt.length;if(t){const e={at:s,len:i-s};k.call(this,e,t)}}function N(t,e,n){const s=this.drafty.txt.length;if(s>=this.maxLength)return;if(t)if("MN"==t.tp){const i=e||Array.isArray(n)&&n.length>0&&n[0].txt||"";this.stripForwardedMention&&0==s&&(this.stripForwardedMention=!1,e=i.startsWith("\u27a6")?"\u27a6 ":null,t=null,n=null)}else{if("QQ"==t.tp)return;if("BR"==t.tp){if(0==s)return;e=" ",t=null}else"EX"==t.tp&&(e=" ")}n?n.forEach(t=>{N.call(this,t.sp,t.txt,t.children)}):e&&(s+e.length>=this.maxLength?this.drafty.txt+=e.slice(0,this.maxLength-s-1)+"\u2026":this.drafty.txt+=e);const i=this.drafty.txt.length;if(t){const e={at:s,len:i-s},n=_[t.tp]||{};if("EX"==t.tp){if(this.attCount>=3)return;this.attCount++}else if(s>=i&&!n.isVoid)return;k.call(this,e,t)}}y.init=function(t){if(void 0===t)t="";else if("string"!=typeof t)return null;return{txt:t}},y.parse=function(t){if("string"!=typeof t)return null;const e=t.split(/\r?\n/),n=[],s={},i=[];e.forEach(t=>{let e,r,o=[];if(p.forEach(e=>{o=o.concat(function(t,e,n,s){const i=[];let r=0,o=t.slice(0);for(;o.length>0;){const a=e.exec(o);if(null==a)break;let c=a.index+a[0].lastIndexOf(a[1]);o=o.slice(c+1),r=(c+=r)+1;const u=n?n.exec(o):null;if(null==u)break;let h=u.index+u[0].indexOf(u[1]);o=o.slice(h+1),r=(h+=r)+1,i.push({txt:t.slice(c+1,h),children:[],at:c,end:h,tp:s})}return i}(t,e.start,e.end,e.name))}),0==o.length)r={txt:t};else{o.sort((t,e)=>{const n=t.at-e.at;return 0!=n?n:e.end-t.end}),o=function t(e){if(0==e.length)return[];const n=[e[0]];let s=e[0];for(let i=1;i<e.length;i++)e[i].at>s.end?(n.push(e[i]),s=e[i]):e[i].end<=s.end&&s.children.push(e[i]);for(let i in n)n[i].children=t(n[i].children);return n}(o);const e=function t(e,n){let s="",i=[];for(let r in e){const o=e[r];if(!o.txt){const e=t(o.children,s.length+n);o.txt=e.txt,i=i.concat(e.fmt)}o.tp&&i.push({at:s.length+n,len:o.txt.length,tp:o.tp}),s+=o.txt}return{txt:s,fmt:i}}(function t(e,n,s,i){const r=[];if(0==i.length)return[];for(let o in i){const s=i[o];s.at>n&&r.push({txt:e.slice(n,s.at)});const a={tp:s.tp},c=t(e,s.at+1,s.end,s.children);c.length>0?a.children=c:a.txt=s.txt,r.push(a),n=s.end+1}return n<s&&r.push({txt:e.slice(n,s)}),r}(t,0,t.length,o),0);r={txt:e.txt,fmt:e.fmt}}if((e=function(t){let e,n=[];if(m.forEach(s=>{for(;null!==(e=s.re.exec(t));)n.push({offset:e.index,len:e[0].length,unique:e[0],data:s.pack(e[0]),type:s.name})}),0==n.length)return n;n.sort((t,e)=>t.offset-e.offset);let s=-1;return n=n.filter(t=>{const e=t.offset>s;return s=t.offset+t.len,e})}(r.txt)).length>0){const t=[];for(let i in e){const r=e[i];let o=s[r.unique];o||(o=n.length,s[r.unique]=o,n.push({tp:r.type,data:r.data})),t.push({at:r.offset,len:r.len,key:o})}r.ent=t}i.push(r)});const r={txt:""};if(i.length>0){r.txt=i[0].txt,r.fmt=(i[0].fmt||[]).concat(i[0].ent||[]);for(let t=1;t<i.length;t++){const e=i[t],n=r.txt.length+1;r.fmt.push({tp:"BR",len:1,at:n-1}),r.txt+=" "+e.txt,e.fmt&&(r.fmt=r.fmt.concat(e.fmt.map(t=>(t.at+=n,t)))),e.ent&&(r.fmt=r.fmt.concat(e.ent.map(t=>(t.at+=n,t))))}0==r.fmt.length&&delete r.fmt,n.length>0&&(r.ent=n)}return r},y.append=function(t,e){if(null==t)return e;if(null==e)return t;t.txt=t.txt||"";const n=t.txt.length;return"string"==typeof e?t.txt+=e:e.txt&&(t.txt+=e.txt),Array.isArray(e.fmt)&&(t.fmt=t.fmt||[],Array.isArray(e.ent)&&(t.ent=t.ent||[]),e.fmt.forEach(s=>{const i={at:s.at+n,len:s.len};-1==s.at&&(i.at=-1,i.len=0),s.tp?i.tp=s.tp:(i.key=t.ent.length,t.ent.push(e.ent[s.key||0])),t.fmt.push(i)})),t},y.insertImage=function(t,e,n){(t=t||{txt:" "}).ent=t.ent||[],t.fmt=t.fmt||[],t.fmt.push({at:e,len:1,key:t.ent.length});const s={tp:"IM",data:{mime:n.mime,val:n.preview,width:n.width,height:n.height,name:n.filename,size:0|n.size,ref:n.refurl}};return n.urlPromise&&(s.data._tempPreview=n._tempPreview,s.data._processing=!0,n.urlPromise.then(t=>{s.data.ref=t,s.data._tempPreview=void 0,s.data._processing=void 0},t=>{s.data._processing=void 0})),t.ent.push(s),t},y.quote=function(t,e,n){const s=y.append(y.appendLineBreak(y.mention(t,e)),n);return s.fmt.push({at:0,len:s.txt.length,tp:"QQ"}),s},y.mention=function(t,e){return{txt:t||"",fmt:[{at:0,len:(t||"").length,key:0}],ent:[{tp:"MN",data:{val:e}}]}},y.appendLink=function(t,e){(t=t||{txt:""}).ent=t.ent||[],t.fmt=t.fmt||[],t.fmt.push({at:t.txt.length,len:e.txt.length,key:t.ent.length}),t.txt+=e.txt;const n={tp:"LN",data:{url:e.url}};return t.ent.push(n),t},y.appendImage=function(t,e){return(t=t||{txt:""}).txt+=" ",y.insertImage(t,t.txt.length-1,e)},y.attachFile=function(t,e){(t=t||{txt:""}).ent=t.ent||[],t.fmt=t.fmt||[],t.fmt.push({at:-1,len:0,key:t.ent.length});const n={tp:"EX",data:{mime:e.mime,val:e.data,name:e.filename,ref:e.refurl,size:0|e.size}};return e.urlPromise&&(n.data._processing=!0,e.urlPromise.then(t=>{n.data.ref=t,n.data._processing=void 0},t=>{n.data._processing=void 0})),t.ent.push(n),t},y.wrapInto=function(t,e,n,s){return"string"==typeof t&&(t={txt:t}),t.fmt=t.fmt||[],t.fmt.push({at:n||0,len:s||t.txt.length,tp:e}),t},y.wrapAsForm=function(t,e,n){return y.wrapInto(t,"FM",e,n)},y.insertButton=function(t,e,n,s,i,r,o){return"string"==typeof t&&(t={txt:t}),!t||!t.txt||t.txt.length<e+n||n<=0||-1==["url","pub"].indexOf(i)?null:"url"!=i||o?(o=""+o,t.ent=t.ent||[],t.fmt=t.fmt||[],t.fmt.push({at:e,len:n,key:t.ent.length}),t.ent.push({tp:"BN",data:{act:i,val:r,ref:o,name:s}}),t):null},y.appendButton=function(t,e,n,s,i,r){const o=(t=t||{txt:""}).txt.length;return t.txt+=e,y.insertButton(t,o,e.length,n,s,i,r)},y.attachJSON=function(t,e){return(t=t||{txt:""}).ent=t.ent||[],t.fmt=t.fmt||[],t.fmt.push({at:-1,len:0,key:t.ent.length}),t.ent.push({tp:"EX",data:{mime:"application/json",val:e}}),t},y.appendLineBreak=function(t){return(t=t||{txt:""}).fmt=t.fmt||[],t.fmt.push({at:t.txt.length,len:1,tp:"BR"}),t.txt+=" ",t},y.UNSAFE_toHTML=function(t){const{txt:e,fmt:n,ent:s}=t,i=[];if(n)for(let c in n){const t=n[c],e=0|t.at;let r,o=t.tp;if(!o){const e=s[0|t.key];e&&(o=e.tp,r=e.data)}v[o]&&(i.push({idx:e+t.len,len:-t.len,what:v[o].close(r)}),i.push({idx:e,len:t.len,what:v[o].open(r)}))}i.sort((t,e)=>e.idx==t.idx?e.len-t.len:e.idx-t.idx);for(let c in i)i[c].what&&(r=e,o=i[c].idx,a=i[c].what,e=r.slice(0,o)+a+r.slice(o));var r,o,a;return e},y.format=function(t,e,n){return M(t.txt,0,(t.txt||"").length,E(t),e,n)},y.normalize=function(t){return T({},S(t),[])},y.shorten=function(t,e,n){let s=S(t);return(s=function(t,e,n){return e-="\u2026".length,R(t,(function(t){if(0==e)return null;if(t.att)return t;if(t.text){const n=t.text.length;n>e?(t.text=t.text.substring(0,e)+"\u2026",e=0):e-=n}return t}))}(s,e))&&n&&(s=function(t){return R(t,(function(t){return t.data=D(t.data,!0),t}))}(s)),T({},s,[])},y.preview=function(t,e,n,s){return x(t,{drafty:y.init(),maxLength:e,keymap:[],attCount:0,stripForwardedMention:s},N,n)},y.forwardedContent=function(t,e){return x(t,{drafty:y.init(),keymap:[],stripForwardedMention:!0},C,e)},y.toPlainText=function(t){return"string"==typeof t?t:t.txt},y.isPlainText=function(t){return"string"==typeof t||!(t.fmt||t.ent)},y.isValid=function(t){if(!t)return!1;const{txt:e,fmt:n,ent:s}=t;if(!e&&""!==e&&!n&&!s)return!1;const i=typeof e;return!("string"!=i&&"undefined"!=i&&null!==e||void 0!==n&&!Array.isArray(n)&&null!==n||void 0!==s&&!Array.isArray(s)&&null!==s)},y.hasAttachments=function(t){if(!Array.isArray(t.fmt))return!1;for(let e in t.fmt){const n=t.fmt[e];if(n&&n.at<0){const e=t.ent[0|n.key];return e&&"EX"==e.tp&&e.data}}return!1},y.attachments=function(t,e,n){if(!Array.isArray(t.fmt))return;let s=0;t.fmt.forEach(i=>{if(i&&i.at<0){const r=t.ent[0|i.key];r&&"EX"==r.tp&&r.data&&e.call(n,r.data,s++,"EX")}})},y.hasEntities=function(t){return t.ent&&t.ent.length>0},y.entities=function(t,e,n){if(t.ent&&t.ent.length>0)for(let s in t.ent)t.ent[s]&&e.call(n,t.ent[s].data,s,t.ent[s].tp)},y.getDownloadUrl=function(t){let e=null;return"application/json"!=t.mime&&t.val?e=b(t.val,t.mime,y.logger):"string"==typeof t.ref&&(e=t.ref),e},y.isProcessing=function(t){return!!t._processing},y.getPreviewUrl=function(t){return t.val?b(t.val,t.mime,y.logger):null},y.getEntitySize=function(t){return t.size?t.size:t.val?.75*t.val.length|0:0},y.getEntityMimeType=function(t){return t.mime||"text/plain"},y.tagName=function(t){return t?_[t]?_[t].name:"_UNKN":void 0},y.attrValue=function(t,e){if(e&&v[t])return v[t].props(e)},y.getContentType=function(){return"text/x-drafty"},f.exports=y,f=f.exports;var q={exports:{}};const{jsonParseHelper:U}=s;let I;const O=function(t,e){this._tinode=t,this._version=e,this._apiKey=t._apiKey,this._authToken=t.getAuthToken(),this._reqId=t.getNextUniqueId(),this.xhr=new I,this.toResolve=null,this.toReject=null,this.onProgress=null,this.onSuccess=null,this.onFailure=null};O.prototype={uploadWithBaseUrl:function(t,e,n,s,i,r){if(!this._authToken)throw new Error("Must authenticate first");const o=this;let a="/v".concat(this._version,"/file/u/");if(t){let e=t;if(e.endsWith("/")&&(e=e.slice(0,-1)),!e.startsWith("http://")&&!e.startsWith("https://"))throw new Error("Invalid base URL '".concat(t,"'"));a=e+a}this.xhr.open("POST",a,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("X-Tinode-Auth","Token ".concat(this._authToken.token));const c=new Promise((t,e)=>{this.toResolve=t,this.toReject=e});this.onProgress=s,this.onSuccess=i,this.onFailure=r,this.xhr.upload.onprogress=t=>{t.lengthComputable&&o.onProgress&&o.onProgress(t.loaded/t.total)},this.xhr.onload=function(){let t;try{t=JSON.parse(this.response,U)}catch(e){o._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.response),t={ctrl:{code:this.status,text:this.statusText}}}this.status>=200&&this.status<300?(o.toResolve&&o.toResolve(t.ctrl.params.url),o.onSuccess&&o.onSuccess(t.ctrl)):this.status>=400?(o.toReject&&o.toReject(new Error("".concat(t.ctrl.text," (").concat(t.ctrl.code,")"))),o.onFailure&&o.onFailure(t.ctrl)):o._tinode.logger("ERROR: Unexpected server response status",this.status,this.response)},this.xhr.onerror=function(t){o.toReject&&o.toReject(new Error("failed")),o.onFailure&&o.onFailure(null)},this.xhr.onabort=function(t){o.toReject&&o.toReject(new Error("upload cancelled by user")),o.onFailure&&o.onFailure(null)};try{const t=new FormData;t.append("file",e),t.set("id",this._reqId),n&&t.set("topic",n),this.xhr.send(t)}catch(u){this.toReject&&this.toReject(u),this.onFailure&&this.onFailure(null)}return c},upload:function(t,e,n,s,i){const r=(this._tinode._secure?"https://":"http://")+this._tinode._host;return this.uploadWithBaseUrl(r,t,e,n,s,i)},download:function(t,e,n,s,i){if(!Tinode.isRelativeURL(t))return void(i&&i("The URL '".concat(t,"' must be relative, not absolute")));if(!this._authToken)return void(i&&i("Must authenticate first"));const r=this;this.xhr.open("GET",t,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("X-Tinode-Auth","Token "+this._authToken.token),this.xhr.responseType="blob",this.onProgress=s,this.xhr.onprogress=function(t){r.onProgress&&r.onProgress(t.loaded)};const o=new Promise((t,e)=>{this.toResolve=t,this.toReject=e});this.xhr.onload=function(){if(200==this.status){const t=document.createElement("a");t.href=window.URL.createObjectURL(new Blob([this.response],{type:n})),t.style.display="none",t.setAttribute("download",e),document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(t.href),r.toResolve&&r.toResolve()}else if(this.status>=400&&r.toReject){const t=new FileReader;t.onload=function(){try{const t=JSON.parse(this.result,U);r.toReject(new Error("".concat(t.ctrl.text," (").concat(t.ctrl.code,")")))}catch(t){r._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.result),r.toReject(t)}},t.readAsText(this.response)}},this.xhr.onerror=function(t){r.toReject&&r.toReject(new Error("failed"))},this.xhr.onabort=function(){r.toReject&&r.toReject(null)};try{this.xhr.send()}catch(a){this.toReject&&this.toReject(a)}return o},cancel:function(){this.xhr&&this.xhr.readyState<4&&this.xhr.abort()},getId:function(){return this._reqId}},O.setNetworkProvider=function(t){I=t},q.exports=O,q=q.exports;var j={exports:{}};const L=function(t){this.topic=t,this.what={}};L.prototype={_get_desc_ims:function(){return this.topic.updated},_get_subs_ims:function(){return this.topic.isP2PType()?this._get_desc_ims():this.topic._lastSubsUpdate},withData:function(t,e,n){return this.what.data={since:t,before:e,limit:n},this},withLaterData:function(t){return this.withData(this.topic._maxSeq>0?this.topic._maxSeq+1:void 0,void 0,t)},withEarlierData:function(t){return this.withData(void 0,this.topic._minSeq>0?this.topic._minSeq:void 0,t)},withDesc:function(t){return this.what.desc={ims:t},this},withLaterDesc:function(){return this.withDesc(this._get_desc_ims())},withSub:function(t,e,n){const s={ims:t,limit:e};return"me"==this.topic.getType()?s.topic=n:s.user=n,this.what.sub=s,this},withOneSub:function(t,e){return this.withSub(t,void 0,e)},withLaterOneSub:function(t){return this.withOneSub(this.topic._lastSubsUpdate,t)},withLaterSub:function(t){return this.withSub(this._get_subs_ims(),t)},withTags:function(){return this.what.tags=!0,this},withCred:function(){return"me"==this.topic.getType()?this.what.cred=!0:this.topic._tinode.logger("ERROR: Invalid topic type for MetaGetBuilder:withCreds",this.topic.getType()),this},withDel:function(t,e){return(t||e)&&(this.what.del={since:t,limit:e}),this},withLaterDel:function(t){return this.withDel(this.topic._maxSeq>0?this.topic._maxDel+1:void 0,t)},extract:function(t){return this.what[t]},build:function(){const t=[];let e={};return["data","sub","desc","tags","cred","del"].map(n=>{this.what.hasOwnProperty(n)&&(t.push(n),Object.getOwnPropertyNames(this.what[n]).length>0&&(e[n]=this.what[n]))}),t.length>0?e.what=t.join(" "):e=void 0,e}},j.exports=L,j=j.exports;var F="0.18.0-rc2",G={exports:{}};return function(e){(function(){"use strict";const{jsonParseHelper:r,isUrlRelative:o}=s,a=F;let c,u,l;"undefined"!=typeof WebSocket&&(c=WebSocket),"undefined"!=typeof XMLHttpRequest&&(u=XMLHttpRequest),"undefined"!=typeof indexedDB&&(l=indexedDB),function(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";"undefined"==typeof btoa&&(e.btoa=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=e,s="";for(let i,r=0,o=0,a=t;n.charAt(0|o)||(a="=",o%1);s+=a.charAt(63&r>>8-o%1*8)){if((i=n.charCodeAt(o+=.75))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");r=r<<8|i}return s}),"undefined"==typeof atob&&(e.atob=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=e.replace(/=+$/,""),s="";if(n.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i,r=0,o=0,a=0;i=n.charAt(a++);~i&&(o=r%4?64*o+i:i,r++%4)?s+=String.fromCharCode(255&o>>(-2*r&6)):0)i=t.indexOf(i);return s}),"undefined"==typeof window&&(e.window={WebSocket:c,XMLHttpRequest:u,indexedDB:l,URL:{createObjectURL:function(){throw new Error("Unable to use URL.createObjectURL in a non-browser application")}}}),i.setNetworkProviders(c,u),q.setNetworkProvider(u),h.setDatabaseProvider(l)}();const d=a||"0.17",p="tinodejs/"+d;function g(t){return t instanceof Date&&!isNaN(t)&&0!=t.getTime()}function m(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function(t,e){return String.fromCharCode("0x"+e)})))}function _(e,n,s){if("object"!=typeof n){if(n===v.DEL_CHAR)return;return void 0===n?e:n}if(null===n)return n;if(n instanceof Date&&!isNaN(n))return!e||!(e instanceof Date)||isNaN(e)||e<n?n:e;if(n instanceof t)return new t(n);if(n instanceof Array)return n;e&&e!==v.DEL_CHAR||(e=n.constructor());for(let t in n)!n.hasOwnProperty(t)||s&&s[t]||"_noForwarding"==t||(e[t]=_(e[t],n[t]));return e}function b(t,e,n,s){return t[e]=_(t[e],n,s),t[e]}function w(e,n){return"string"==typeof n&&n.length>128?"<"+n.length+", bytes: "+n.substring(0,12)+"..."+n.substring(n.length-12)+">":function(e,n){if(n instanceof Date)n=function(t){if(!g(t))return;const e=function(t,e){return"0".repeat((e=e||2)-(""+t).length)+t},n=t.getUTCMilliseconds();return t.getUTCFullYear()+"-"+e(t.getUTCMonth()+1)+"-"+e(t.getUTCDate())+"T"+e(t.getUTCHours())+":"+e(t.getUTCMinutes())+":"+e(t.getUTCSeconds())+(n?"."+e(n,3):"")+"Z"}(n);else if(n instanceof t)n=n.jsonHelper();else if(null==n||!1===n||Array.isArray(n)&&0==n.length||"object"==typeof n&&0==Object.keys(n).length)return;return n}(0,n)}const v=function(t,e){var n=this;this._host=t.host,this._secure=t.secure,this._appName=t.appName||"Undefined",this._apiKey=t.apiKey,this._browser="",this._platform=t.platform||"web",this._hwos="undefined",this._humanLanguage="xx","undefined"!=typeof navigator&&(this._browser=function(t,e){t=t||"";let n,s="";/reactnative/i.test(e)&&(s="ReactNative; ");let i=(t=t.replace(" (KHTML, like Gecko)","")).match(/(AppleWebKit\/[.\d]+)/i);if(i){const e=["edg","chrome","safari","mobile","version"];let s,r=t.substr(i.index+i[0].length).split(" "),o=[];for(let t=0;t<r.length;t++){let n=/([\w.]+)[\/]([\.\d]+)/.exec(r[t]);n&&(o.push([n[1],n[2],e.findIndex(t=>n[1].toLowerCase().startsWith(t))]),"Version"==n[1]&&(s=n[2]))}o.sort((t,e)=>t[2]-e[2]),o.length>0?(o[0][0].toLowerCase().startsWith("edg")?o[0][0]="Edge":"OPR"==o[0][0]?o[0][0]="Opera":"Safari"==o[0][0]&&s&&(o[0][1]=s),n=o[0][0]+"/"+o[0][1]):n=i[1]}else n=/firefox/i.test(t)?(i=/Firefox\/([.\d]+)/g.exec(t))?"Firefox/"+i[1]:"Firefox/?":(i=/([\w.]+)\/([.\d]+)/.exec(t))?i[1]+"/"+i[2]:(i=t.split(" "))[0];if((i=n.split("/")).length>1){const t=i[1].split("."),e=t[1]?"."+t[1].substr(0,2):"";n="".concat(i[0],"/").concat(t[0]).concat(e)}return s+n}(navigator.userAgent,navigator.product),this._hwos=navigator.platform,this._humanLanguage=navigator.language||"en-US"),this._loggingEnabled=!1,this._trimLongStrings=!1,this._myUID=null,this._authenticated=!1,this._login=null,this._authToken=null,this._inPacketCount=0,this._messageId=Math.floor(65535*Math.random()+65535),this._serverInfo=null,this._deviceToken=null,this._pendingPromises={},this._expirePromises=null,this.logger=function(t){if(n._loggingEnabled){const n=new Date,r=("0"+n.getUTCHours()).slice(-2)+":"+("0"+n.getUTCMinutes()).slice(-2)+":"+("0"+n.getUTCSeconds()).slice(-2)+"."+("00"+n.getUTCMilliseconds()).slice(-3);for(var e=arguments.length,s=new Array(e>1?e-1:0),i=1;i<e;i++)s[i-1]=arguments[i];console.log("["+r+"]",t,s.join(" "))}},i.logger=this.logger,f.logger=this.logger,"lp"!=t.transport&&"ws"!=t.transport&&(t.transport=function(){if("object"==typeof window){if(window.WebSocket)return"ws";if(window.XMLHttpRequest)return"lp"}return null}()),this._connection=new i(t,"0",!0),this._cache={};const s=this.cachePut=(t,e,n)=>{this._cache[t+":"+e]=n},o=this.cacheGet=(t,e)=>this._cache[t+":"+e],a=this.cacheDel=(t,e)=>{delete this._cache[t+":"+e]},c=this.cacheMap=(t,e,n)=>{const s=t?t+":":void 0;for(let i in this._cache)if((!s||0==i.indexOf(s))&&e.call(n,this._cache[i],i))break};if(this.attachCacheToTopic=t=>{t._tinode=this,t._cacheGetUser=t=>{const e=o("user",t);if(e)return{user:t,public:_({},e)}},t._cachePutUser=(t,e)=>s("user",t,_({},e.public)),t._cacheDelUser=t=>a("user",t),t._cachePutSelf=()=>s("topic",t.name,t),t._cacheDelSelf=()=>a("topic",t.name)},this._persist=t.persist,this._db=h(t=>{this.logger("DB",t)},this.logger),this._persist){const t=[];this._db.initDatabase().then(()=>this._db.mapTopics(e=>{let n=this.cacheGet("topic",e.name);n||(n="me"==e.name?new x:"fnd"==e.name?new M:new y(e.name),this._db.deserializeTopic(n,e),this.attachCacheToTopic(n),n._cachePutSelf(),t.push(n._loadMessages(this._db)))})).then(()=>this._db.mapUsers(t=>s("user",t.uid,_({},t.public)))).then(()=>Promise.all(t)).then(()=>{e&&e(),this.logger("Persistent cache initialized.")})}else this._db.deleteDatabase().then(()=>{e&&e()});const u=(t,e,n,s)=>{const i=this._pendingPromises[t];i&&(delete this._pendingPromises[t],e>=200&&e<400?i.resolve&&i.resolve(n):i.reject&&i.reject(new Error("".concat(s," (").concat(e,")"))))},l=t=>{let e=null;return t&&(e=new Promise((e,n)=>{this._pendingPromises[t]={resolve:e,reject:n,ts:new Date}})),e},m=this.getNextUniqueId=()=>0!=this._messageId?""+this._messageId++:void 0,b=()=>this._appName+" ("+(this._browser?this._browser+"; ":"")+this._hwos+"); "+p;this.initPacket=(t,e)=>{switch(t){case"hi":return{hi:{id:m(),ver:d,ua:b(),dev:this._deviceToken,lang:this._humanLanguage,platf:this._platform}};case"acc":return{acc:{id:m(),user:null,scheme:null,secret:null,login:!1,tags:null,desc:{},cred:{}}};case"login":return{login:{id:m(),scheme:null,secret:null}};case"sub":return{sub:{id:m(),topic:e,set:{},get:{}}};case"leave":return{leave:{id:m(),topic:e,unsub:!1}};case"pub":return{pub:{id:m(),topic:e,noecho:!1,head:null,content:{}}};case"get":return{get:{id:m(),topic:e,what:null,desc:{},sub:{},data:{}}};case"set":return{set:{id:m(),topic:e,desc:{},sub:{},tags:[]}};case"del":return{del:{id:m(),topic:e,what:null,delseq:null,user:null,hard:!1}};case"note":return{note:{topic:e,what:null,seq:void 0}};default:throw new Error("Unknown packet type requested: ".concat(t))}},this.send=(t,e)=>{let n;e&&(n=l(e)),t=function t(e){return Object.keys(e).forEach(n=>{"_"==n[0]?delete e[n]:e[n]?Array.isArray(e[n])&&0==e[n].length?delete e[n]:e[n]?e[n]instanceof Date?g(e[n])||delete e[n]:"object"==typeof e[n]&&(t(e[n]),0==Object.getOwnPropertyNames(e[n]).length&&delete e[n]):delete e[n]:delete e[n]}),e}(t);let s=JSON.stringify(t);this.logger("out: "+(this._trimLongStrings?JSON.stringify(t,w):s));try{this._connection.sendText(s)}catch(r){if(!e)throw r;u(e,i.NETWORK_ERROR,null,r.message)}return n},this.loginSuccessful=t=>t.params&&t.params.user?(this._myUID=t.params.user,this._authenticated=t&&t.code>=200&&t.code<300,t.params&&t.params.token&&t.params.expires?this._authToken={token:t.params.token,expires:t.params.expires}:this._authToken=null,this.onLogin&&this.onLogin(t.code,t.text),t):t,this._connection.onMessage=t=>{if(!t)return;if(this._inPacketCount++,this.onRawMessage&&this.onRawMessage(t),"0"===t)return void(this.onNetworkProbe&&this.onNetworkProbe());let e=JSON.parse(t,r);e?(this.logger("in: "+(this._trimLongStrings?JSON.stringify(e,w):t)),this.onMessage&&this.onMessage(e),e.ctrl?(this.onCtrlMessage&&this.onCtrlMessage(e.ctrl),e.ctrl.id&&u(e.ctrl.id,e.ctrl.code,e.ctrl,e.ctrl.text),setTimeout(()=>{if(205==e.ctrl.code&&"evicted"==e.ctrl.text){const t=o("topic",e.ctrl.topic);t&&(t._resetSub(),e.ctrl.params&&e.ctrl.params.unsub&&t._gone())}else if(e.ctrl.code<300&&e.ctrl.params)if("data"==e.ctrl.params.what){const t=o("topic",e.ctrl.topic);t&&t._allMessagesReceived(e.ctrl.params.count)}else if("sub"==e.ctrl.params.what){const t=o("topic",e.ctrl.topic);t&&t._processMetaSub([])}},0)):setTimeout(()=>{if(e.meta){const t=o("topic",e.meta.topic);t&&t._routeMeta(e.meta),e.meta.id&&u(e.meta.id,200,e.meta,"META"),this.onMetaMessage&&this.onMetaMessage(e.meta)}else if(e.data){const t=o("topic",e.data.topic);t&&t._routeData(e.data),this.onDataMessage&&this.onDataMessage(e.data)}else if(e.pres){const t=o("topic",e.pres.topic);t&&t._routePres(e.pres),this.onPresMessage&&this.onPresMessage(e.pres)}else if(e.info){const t=o("topic",e.info.topic);t&&t._routeInfo(e.info),this.onInfoMessage&&this.onInfoMessage(e.info)}else this.logger("ERROR: Unknown packet received.")},0)):(this.logger("in: "+t),this.logger("ERROR: failed to parse data"))},this._connection.onOpen=()=>{this._expirePromises||(this._expirePromises=setInterval(()=>{const t=new Error("Timeout (504)"),e=new Date((new Date).getTime()-5e3);for(let n in this._pendingPromises){let s=this._pendingPromises[n];s&&s.ts<e&&(this.logger("Promise expired",n),delete this._pendingPromises[n],s.reject&&s.reject(t))}},1e3)),this.hello()},this._connection.onAutoreconnectIteration=(t,e)=>{this.onAutoreconnectIteration&&this.onAutoreconnectIteration(t,e)},this._connection.onDisconnect=(t,e)=>{this._inPacketCount=0,this._serverInfo=null,this._authenticated=!1,this._expirePromises&&(clearInterval(this._expirePromises),this._expirePromises=null),c("topic",(t,e)=>{t._resetSub()});for(let n in this._pendingPromises){const e=this._pendingPromises[n];e&&e.reject&&e.reject(t)}this._pendingPromises={},this.onDisconnect&&this.onDisconnect(t)}};v.credential=function(t,e,n,s){return"object"==typeof t&&({val:e,params:n,resp:s,meth:t}=t),t&&(e||s)?[{meth:t,val:e,resp:s,params:n}]:null},v.topicType=function(t){return{me:"me",fnd:"fnd",grp:"grp",new:"grp",nch:"grp",chn:"grp",usr:"p2p",sys:"sys"}["string"==typeof t?t.substring(0,3):"xxx"]},v.isMeTopicName=function(t){return"me"==v.topicType(t)},v.isGroupTopicName=function(t){return"grp"==v.topicType(t)},v.isP2PTopicName=function(t){return"p2p"==v.topicType(t)},v.isCommTopicName=function(t){return v.isP2PTopicName(t)||v.isGroupTopicName(t)},v.isNewGroupTopicName=function(t){return"string"==typeof t&&("new"==t.substring(0,3)||"nch"==t.substring(0,3))},v.isChannelTopicName=function(t){return"string"==typeof t&&("chn"==t.substring(0,3)||"nch"==t.substring(0,3))},v.getVersion=function(){return d},v.setNetworkProviders=function(t,e){c=t,u=e,i.setNetworkProviders(c,u),q.setNetworkProvider(u)},v.setDatabaseProvider=function(t){l=t,h.setDatabaseProvider(l)},v.getLibrary=function(){return p},v.MESSAGE_STATUS_NONE=0,v.MESSAGE_STATUS_QUEUED=1,v.MESSAGE_STATUS_SENDING=2,v.MESSAGE_STATUS_FAILED=3,v.MESSAGE_STATUS_SENT=4,v.MESSAGE_STATUS_RECEIVED=5,v.MESSAGE_STATUS_READ=6,v.MESSAGE_STATUS_TO_ME=7,v.MESSAGE_STATUS_DEL_RANGE=8,v.DEL_CHAR="\u2421",v.isNullValue=function(t){return t===v.DEL_CHAR},v.isRelativeURL=function(t){return!/^\s*([a-z][a-z0-9+.-]*:|\/\/)/im.test(t)},v.MAX_MESSAGE_SIZE="maxMessageSize",v.MAX_SUBSCRIBER_COUNT="maxSubscriberCount",v.MAX_TAG_COUNT="maxTagCount",v.MAX_FILE_UPLOAD_SIZE="maxFileUploadSize",v.prototype={connect:function(t){return this._connection.connect(t)},reconnect:function(t){this._connection.reconnect(t)},disconnect:function(){this._connection.disconnect()},clearStorage:function(){return this._db.isReady()?this._db.deleteDatabase():Promise.resolve()},initStorage:function(){return this._db.isReady()?Promise.resolve():this._db.initDatabase()},networkProbe:function(){this._connection.probe()},isConnected:function(){return this._connection.isConnected()},isAuthenticated:function(){return this._authenticated},authorizeURL:function(t){if("string"!=typeof t)return t;if(v.isRelativeURL(t)){const e="scheme://host/",n=new URL(t,e);this._apiKey&&n.searchParams.append("apikey",this._apiKey),this._authToken&&this._authToken.token&&(n.searchParams.append("auth","token"),n.searchParams.append("secret",this._authToken.token)),t=n.toString().substring(e.length-1)}return t},account:function(t,e,n,s,i){const r=this.initPacket("acc");return r.acc.user=t,r.acc.scheme=e,r.acc.secret=n,r.acc.login=s,i&&(r.acc.desc.defacs=i.defacs,r.acc.desc.public=i.public,r.acc.desc.private=i.private,r.acc.desc.trusted=i.trusted,r.acc.tags=i.tags,r.acc.cred=i.cred,r.acc.token=i.token,Array.isArray(i.attachments)&&i.attachments.length>0&&(r.extra={attachments:i.attachments.filter(t=>v.isRelativeURL(t))})),this.send(r,r.acc.id)},createAccount:function(t,e,n,s){let i=this.account("new",t,e,n,s);return n&&(i=i.then(t=>this.loginSuccessful(t))),i},createAccountBasic:function(t,e,n){return t=t||"",e=e||"",this.createAccount("basic",m(t+":"+e),!0,n)},updateAccountBasic:function(t,e,n,s){return e=e||"",n=n||"",this.account(t,"basic",m(e+":"+n),!1,s)},hello:function(){const t=this.initPacket("hi");return this.send(t,t.hi.id).then(t=>(this._connection.backoffReset(),t.params&&(this._serverInfo=t.params),this.onConnect&&this.onConnect(),t)).catch(t=>{this._connection.reconnect(!0),this.onDisconnect&&this.onDisconnect(t)})},setDeviceToken:function(t){let e=!1;return(t=t||null)!=this._deviceToken&&(this._deviceToken=t,this.isConnected()&&this.isAuthenticated()&&(this.send({hi:{dev:t||v.DEL_CHAR}}),e=!0)),e},login:function(t,e,n){const s=this.initPacket("login");return s.login.scheme=t,s.login.secret=e,s.login.cred=n,this.send(s,s.login.id).then(t=>this.loginSuccessful(t))},loginBasic:function(t,e,n){return this.login("basic",m(t+":"+e),n).then(e=>(this._login=t,e))},loginToken:function(t,e){return this.login("token",t,e)},requestResetAuthSecret:function(t,e,n){return this.login("reset",m(t+":"+e+":"+n))},getAuthToken:function(){return this._authToken&&this._authToken.expires.getTime()>Date.now()?this._authToken:(this._authToken=null,null)},setAuthToken:function(t){this._authToken=t},subscribe:function(t,e,n){const s=this.initPacket("sub",t);if(t||(t="new"),s.sub.get=e,n){if(n.sub&&(s.sub.set.sub=n.sub),n.desc){const e=n.desc;v.isNewGroupTopicName(t)?s.sub.set.desc=e:v.isP2PTopicName(t)&&e.defacs&&(s.sub.set.desc={defacs:e.defacs})}Array.isArray(n.attachments)&&n.attachments.length>0&&(s.extra={attachments:n.attachments.filter(t=>v.isRelativeURL(t))}),n.tags&&(s.sub.set.tags=n.tags)}return this.send(s,s.sub.id)},leave:function(t,e){const n=this.initPacket("leave",t);return n.leave.unsub=e,this.send(n,n.leave.id)},createMessage:function(t,e,n){const s=this.initPacket("pub",t);let i="string"==typeof e?f.parse(e):e;return i&&!f.isPlainText(i)&&(s.pub.head={mime:f.getContentType()},e=i),s.pub.noecho=n,s.pub.content=e,s.pub},publish:function(t,e,n){return this.publishMessage(this.createMessage(t,e,n))},publishMessage:function(t,e){(t=Object.assign({},t)).seq=void 0,t.from=void 0,t.ts=void 0;const n={pub:t};return e&&(n.extra={attachments:e.filter(t=>v.isRelativeURL(t))}),this.send(n,t.id)},oobNotification:function(t,e,n){const s=this.cacheGet("topic",t);s&&(s._updateReceived(e,n),this.getMeTopic()._refreshContact("msg",s))},getMeta:function(t,e){const n=this.initPacket("get",t);return n.get=_(n.get,e),this.send(n,n.get.id)},setMeta:function(t,e){const n=this.initPacket("set",t),s=[];return e&&(["desc","sub","tags","cred"].forEach((function(t){e.hasOwnProperty(t)&&(s.push(t),n.set[t]=e[t])})),Array.isArray(e.attachments)&&e.attachments.length>0&&(n.extra={attachments:e.attachments.filter(t=>v.isRelativeURL(t))})),0==s.length?Promise.reject(new Error("Invalid {set} parameters")):this.send(n,n.set.id)},delMessages:function(t,e,n){const s=this.initPacket("del",t);return s.del.what="msg",s.del.delseq=e,s.del.hard=n,this.send(s,s.del.id)},delTopic:function(t,e){const n=this.initPacket("del",t);return n.del.what="topic",n.del.hard=e,this.send(n,n.del.id)},delSubscription:function(t,e){const n=this.initPacket("del",t);return n.del.what="sub",n.del.user=e,this.send(n,n.del.id)},delCredential:function(t,e){const n=this.initPacket("del","me");return n.del.what="cred",n.del.cred={meth:t,val:e},this.send(n,n.del.id)},delCurrentUser:function(t){const e=this.initPacket("del",null);return e.del.what="user",e.del.hard=t,this.send(e,e.del.id).then(t=>{this._myUID=null})},note:function(t,e,n){if(n<=0||n>=268435455)throw new Error("Invalid message id ".concat(n));const s=this.initPacket("note",t);s.note.what=e,s.note.seq=n,this.send(s)},noteKeyPress:function(t){const e=this.initPacket("note",t);e.note.what="kp",this.send(e)},getTopic:function(t){let e=this.cacheGet("topic",t);return!e&&t&&(e="me"==t?new x:"fnd"==t?new M:new y(t),this.attachCacheToTopic(e),e._cachePutSelf()),e},isTopicCached:function(t){return!!this.cacheGet("topic",t)},newGroupTopicName:function(t){return(t?"nch":"new")+this.getNextUniqueId()},getMeTopic:function(){return this.getTopic("me")},getFndTopic:function(){return this.getTopic("fnd")},getLargeFileHelper:function(){return new q(this,"0")},getCurrentUserID:function(){return this._myUID},isMe:function(t){return this._myUID===t},getCurrentLogin:function(){return this._login},getServerInfo:function(){return this._serverInfo},getServerLimit:function(t,e){return(this._serverInfo?this._serverInfo[t]:null)||e},enableLogging:function(t,e){this._loggingEnabled=t,this._trimLongStrings=t&&e},setHumanLanguage:function(t){t&&(this._humanLanguage=t)},isTopicOnline:function(t){const e=this.cacheGet("topic",t);return e&&e.online},getTopicAccessMode:function(t){const e=this.cacheGet("topic",t);return e?e.acs:null},wantAkn:function(t){this._messageId=t?Math.floor(16777215*Math.random()+16777215):0},onWebsocketOpen:void 0,onConnect:void 0,onDisconnect:void 0,onLogin:void 0,onCtrlMessage:void 0,onDataMessage:void 0,onPresMessage:void 0,onMessage:void 0,onRawMessage:void 0,onNetworkProbe:void 0,onAutoreconnectIteration:void 0};const y=function(e,s){this._tinode=null,this.name=e,this.created=null,this.updated=null,this.touched=new Date(0),this.acs=new t(null),this.private=null,this.public=null,this.trusted=null,this._users={},this._queuedSeqId=268435455,this._maxSeq=0,this._minSeq=0,this._noEarlierMsgs=!1,this._maxDel=0,this._tags=[],this._credentials=[],this._messages=n((function(t,e){return t.seq-e.seq}),!0),this._subscribed=!1,this._lastSubsUpdate=new Date(0),this._new=!0,s&&(this.onData=s.onData,this.onMeta=s.onMeta,this.onPres=s.onPres,this.onInfo=s.onInfo,this.onMetaDesc=s.onMetaDesc,this.onMetaSub=s.onMetaSub,this.onSubsUpdated=s.onSubsUpdated,this.onTagsUpdated=s.onTagsUpdated,this.onCredsUpdated=s.onCredsUpdated,this.onDeleteTopic=s.onDeleteTopic,this.onAllMessagesReceived=s.onAllMessagesReceived)};y.prototype={isSubscribed:function(){return this._subscribed},subscribe:function(t,e){return this._subscribed?Promise.resolve(this):this._tinode.subscribe(this.name||"new",t,e).then(t=>{if(t.code>=300)return t;if(this._subscribed=!0,this.acs=t.params&&t.params.acs?t.params.acs:this.acs,this._new){if(this._new=!1,this.name!=t.topic&&(this._cacheDelSelf(),this.name=t.topic),this._cachePutSelf(),this.created=t.ts,this.updated=t.ts,"me"!=this.name&&"fnd"!=this.name){const t=this._tinode.getMeTopic();t.onMetaSub&&t.onMetaSub(this),t.onSubsUpdated&&t.onSubsUpdated([this.name],1)}e&&e.desc&&(e.desc._noForwarding=!0,this._processMetaDesc(e.desc))}return t})},createMessage:function(t,e){return this._tinode.createMessage(this.name,t,e)},publish:function(t,e){return this.publishMessage(this.createMessage(t,e))},publishMessage:function(t){if(!this._subscribed)return Promise.reject(new Error("Cannot publish on inactive topic"));let e=null;return f.hasEntities(t.content)&&(e=[],f.entities(t.content,t=>{t&&t.ref&&e.push(t.ref)}),0==e.length&&(e=null)),t._sending=!0,t._failed=!1,this._tinode.publishMessage(t,e).then(e=>(t._sending=!1,t.ts=e.ts,this.swapMessageId(t,e.params.seq),this._routeData(t),e)).catch(e=>{this._tinode.logger("WARNING: Message rejected by the server",e),t._sending=!1,t._failed=!0,this.onData&&this.onData()})},publishDraft:function(t,e){if(!e&&!this._subscribed)return Promise.reject(new Error("Cannot publish on inactive topic"));const n=t.seq||this._getQueuedSeqId();return t._noForwarding||(t._noForwarding=!0,t.seq=n,t.ts=new Date,t.from=this._tinode.getCurrentUserID(),t.noecho=!0,this._messages.put(t),this._tinode._db.addMessage(t),this.onData&&this.onData(t)),(e||Promise.resolve()).then(()=>t._cancelled?{code:300,text:"cancelled"}:this.publishMessage(t),e=>{this._tinode.logger("WARNING: Message draft rejected",e),t._sending=!1,t._failed=!0,this._messages.delAt(this._messages.find(t)),this._tinode._db.remMessages(this.name,t.seq),this.onData&&this.onData()})},leave:function(t){return this._subscribed||t?this._tinode.leave(this.name,t).then(e=>(this._resetSub(),t&&this._gone(),e)):Promise.reject(new Error("Cannot leave inactive topic"))},getMeta:function(t){return this._tinode.getMeta(this.name,t)},getMessagesPage:function(t,e){let n=e?this.startMetaQuery().withLaterData(t):this.startMetaQuery().withEarlierData(t);return this._loadMessages(this._tinode._db,n.extract("data")).then(s=>{if(s==t)return Promise.resolve({topic:this.name,code:200,params:{count:s}});t-=s,n=e?this.startMetaQuery().withLaterData(t):this.startMetaQuery().withEarlierData(t);let i=this.getMeta(n.build());return e||(i=i.then(t=>{t&&t.params&&!t.params.count&&(this._noEarlierMsgs=!0)})),i})},setMeta:function(t){return t.tags&&(t.tags=function(t){let e=[];if(Array.isArray(t)){for(let n=0,s=t.length;n<s;n++){let s=t[n];s&&(s=s.trim().toLowerCase()).length>1&&e.push(s)}e.sort().filter((function(t,e,n){return!e||t!=n[e-1]}))}return 0==e.length&&e.push(v.DEL_CHAR),e}(t.tags)),this._tinode.setMeta(this.name,t).then(e=>(e&&e.code>=300||(t.sub&&(t.sub.topic=this.name,e.params&&e.params.acs&&(t.sub.acs=e.params.acs,t.sub.updated=e.ts),t.sub.user||(t.sub.user=this._tinode.getCurrentUserID(),t.desc||(t.desc={})),t.sub._noForwarding=!0,this._processMetaSub([t.sub])),t.desc&&(e.params&&e.params.acs&&(t.desc.acs=e.params.acs,t.desc.updated=e.ts),this._processMetaDesc(t.desc)),t.tags&&this._processMetaTags(t.tags),t.cred&&this._processMetaCreds([t.cred],!0)),e))},updateMode:function(t,e){const n=t?this.subscriber(t):null,s=n?n.acs.updateGiven(e).getGiven():this.getAccessMode().updateWant(e).getWant();return this.setMeta({sub:{user:t,mode:s}})},invite:function(t,e){return this.setMeta({sub:{user:t,mode:e}})},archive:function(t){return this.private&&!this.private.arch==!t?Promise.resolve(t):this.setMeta({desc:{private:{arch:!!t||v.DEL_CHAR}}})},delMessages:function(t,e){if(!this._subscribed)return Promise.reject(new Error("Cannot delete messages in inactive topic"));t.sort((t,e)=>t.low<e.low||t.low==e.low&&(!e.hi||t.hi>=e.hi));let n,s=t.reduce((t,e)=>(e.low<268435455&&(!e.hi||e.hi<268435455?t.push(e):t.push({low:e.low,hi:this._maxSeq+1})),t),[]);return(n=s.length>0?this._tinode.delMessages(this.name,s,e):Promise.resolve({params:{del:0}})).then(e=>(e.params.del>this._maxDel&&(this._maxDel=e.params.del),t.forEach(t=>{t.hi?this.flushMessageRange(t.low,t.hi):this.flushMessage(t.low)}),this._updateDeletedRanges(),this.onData&&this.onData(),e))},delMessagesAll:function(t){return!this._maxSeq||this._maxSeq<=0?Promise.resolve():this.delMessages([{low:1,hi:this._maxSeq+1,_all:!0}],t)},delMessagesList:function(t,e){t.sort((t,e)=>t-e);let n=t.reduce((t,e)=>{if(0==t.length)t.push({low:e});else{let n=t[t.length-1];!n.hi&&e!=n.low+1||e>n.hi?t.push({low:e}):n.hi=n.hi?Math.max(n.hi,e+1):e+1}return t},[]);return this.delMessages(n,e)},delTopic:function(t){return this._tinode.delTopic(this.name,t).then(t=>(this._resetSub(),this._gone(),t))},delSubscription:function(t){return this._subscribed?this._tinode.delSubscription(this.name,t).then(e=>(delete this._users[t],this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users)),e)):Promise.reject(new Error("Cannot delete subscription in inactive topic"))},note:function(t,e){if(!this._subscribed)return;const n=this._users[this._tinode.getCurrentUserID()];let s=!1;n?(!n[t]||n[t]<e)&&(n[t]=e,s=!0):s=(0|this[t])<e,s&&(this._tinode.note(this.name,t,e),this._updateReadRecv(t,e),null!=this.acs&&!this.acs.isMuted())&&this._tinode.getMeTopic()._refreshContact(t,this)},noteRecv:function(t){this.note("recv",t)},noteRead:function(t){(t=t||this._maxSeq)>0&&this.note("read",t)},noteKeyPress:function(){this._subscribed?this._tinode.noteKeyPress(this.name):this._tinode.logger("INFO: Cannot send notification in inactive topic")},_updateReadRecv:function(t,e,n){let s,i=!1;switch(e|=0,this.seq=0|this.seq,this.read=0|this.read,this.recv=0|this.recv,t){case"recv":s=this.recv,this.recv=Math.max(this.recv,e),i=s!=this.recv;break;case"read":s=this.read,this.read=Math.max(this.read,e),i=s!=this.read;break;case"msg":s=this.seq,this.seq=Math.max(this.seq,e),(!this.touched||this.touched<n)&&(this.touched=n),i=s!=this.seq}return this.recv<this.read&&(this.recv=this.read,i=!0),this.seq<this.recv&&(this.seq=this.recv,(!this.touched||this.touched<n)&&(this.touched=n),i=!0),this.unread=this.seq-this.read,i},userDesc:function(t){const e=this._cacheGetUser(t);if(e)return e},p2pPeerDesc:function(){if(this.isP2PType())return this._users[this.name]},subscribers:function(t,e){const n=t||this.onMetaSub;if(n)for(let s in this._users)n.call(e,this._users[s],s,this._users)},tags:function(){return this._tags.slice(0)},subscriber:function(t){return this._users[t]},messages:function(t,e,n,s){const i=t||this.onData;if(i){const t="number"==typeof e?this._messages.find({seq:e},!0):void 0,r="number"==typeof n?this._messages.find({seq:n},!0):void 0;-1!=t&&-1!=r&&this._messages.forEach(i,t,r,s)}},findMessage:function(t){const e=this._messages.find({seq:t});if(e>=0)return this._messages.getAt(e)},latestMessage:function(t){const e=this._messages.getLast();return t&&e&&8==e._status?this._messages.getLast(1):e},maxMsgSeq:function(){return this._maxSeq},maxClearId:function(){return this._maxDel},messageCount:function(){return this._messages.length()},queuedMessages:function(t,e){if(!t)throw new Error("Callback must be provided");this.messages(t,268435455,void 0,e)},msgReceiptCount:function(t,e){let n=0;if(e>0){const s=this._tinode.getCurrentUserID();for(let i in this._users){const r=this._users[i];r.user!==s&&r[t]>=e&&n++}}return n},msgReadCount:function(t){return this.msgReceiptCount("read",t)},msgRecvCount:function(t){return this.msgReceiptCount("recv",t)},msgHasMoreMessages:function(t){return t?this.seq>this._maxSeq:this._minSeq>1&&!this._noEarlierMsgs},isNewMessage:function(t){return this._maxSeq<=t},flushMessage:function(t){const e=this._messages.find({seq:t});if(e>=0)return this._tinode._db.remMessages(this.name,t),this._messages.delAt(e)},swapMessageId:function(t,e){const n=this._messages.find(t),s=this._messages.length();0<=n&&n<s&&(this._messages.delAt(n),this._tinode._db.remMessages(this.name,t.seq),t.seq=e,this._messages.put(t),this._tinode._db.addMessage(t))},flushMessageRange:function(t,e){this._tinode._db.remMessages(this.name,t,e);const n=this._messages.find({seq:t},!0);return n>=0?this._messages.delRange(n,this._messages.find({seq:e},!0)):[]},cancelSend:function(t){const e=this._messages.find({seq:t});if(e>=0){const n=this._messages.getAt(e),s=this.msgStatus(n);if(1==s||3==s)return this._tinode._db.remMessages(this.name,t),n._cancelled=!0,this._messages.delAt(e),this.onData&&this.onData(),!0}return!1},getType:function(){return v.topicType(this.name)},getAccessMode:function(){return this.acs},setAccessMode:function(e){return this.acs=new t(e)},getDefaultAccess:function(){return this.defacs},startMetaQuery:function(){return new j(this)},isArchived:function(){return this.private&&!!this.private.arch},isMeType:function(){return v.isMeTopicName(this.name)},isChannelType:function(){return v.isChannelTopicName(this.name)},isGroupType:function(){return v.isGroupTopicName(this.name)},isP2PType:function(){return v.isP2PTopicName(this.name)},isCommType:function(){return v.isCommTopicName(this.name)},msgStatus:function(t,e){let n=0;return this._tinode.isMe(t.from)?t._sending?n=2:t._failed||t._cancelled?n=3:t.seq>=268435455?n=1:this.msgReadCount(t.seq)>0?n=6:this.msgRecvCount(t.seq)>0?n=5:t.seq>0&&(n=4):8==t._status||(n=7),e&&t._status!=n&&(t._status=n,this._tinode._db.updMessageStatus(this.name,t.seq,n)),n},_routeData:function(t){t.content&&(!this.touched||this.touched<t.ts)&&(this.touched=t.ts,this._tinode._db.updTopic(this)),t.seq>this._maxSeq&&(this._maxSeq=t.seq),(t.seq<this._minSeq||0==this._minSeq)&&(this._minSeq=t.seq),t._noForwarding||(this._messages.put(t),this._tinode._db.addMessage(t),this._updateDeletedRanges()),this.onData&&this.onData(t);const e=!this.isChannelType()&&!t.from||this._tinode.isMe(t.from)?"read":"msg";this._updateReadRecv(e,t.seq,t.ts),this._tinode.getMeTopic()._refreshContact(e,this)},_routeMeta:function(t){t.desc&&this._processMetaDesc(t.desc),t.sub&&t.sub.length>0&&this._processMetaSub(t.sub),t.del&&this._processDelMessages(t.del.clear,t.del.delseq),t.tags&&this._processMetaTags(t.tags),t.cred&&this._processMetaCreds(t.cred),this.onMeta&&this.onMeta(t)},_routePres:function(e){let n,s;switch(e.what){case"del":this._processDelMessages(e.clear,e.delseq);break;case"on":case"off":(n=this._users[e.src])?n.online="on"==e.what:this._tinode.logger("WARNING: Presence update for an unknown user",this.name,e.src);break;case"term":this._resetSub();break;case"upd":e.src&&!this._tinode.isTopicCached(e.src)&&this.getMeta(this.startMetaQuery().withLaterOneSub(e.src).build());break;case"acs":if(s=e.src||this._tinode.getCurrentUserID(),n=this._users[s])n.acs.updateAll(e.dacs),this._processMetaSub([{user:s,updated:new Date,acs:n.acs}]);else{const i=(new t).updateAll(e.dacs);i&&i.mode!=t._NONE&&((n=this._cacheGetUser(s))?n.acs=i:(n={user:s,acs:i},this.getMeta(this.startMetaQuery().withOneSub(void 0,s).build())),n.updated=new Date,this._processMetaSub([n]))}break;default:this._tinode.logger("INFO: Ignored presence update",e.what)}this.onPres&&this.onPres(e)},_routeInfo:function(t){if("kp"!==t.what){const e=this._users[t.from];e&&(e[t.what]=t.seq,e.recv<e.read&&(e.recv=e.read));const n=this.latestMessage();n&&this.msgStatus(n,!0),this._tinode.isMe(t.from)&&this._updateReadRecv(t.what,t.seq),this._tinode.getMeTopic()._refreshContact(t.what,this)}this.onInfo&&this.onInfo(t)},_processMetaDesc:function(t){if(this.isP2PType()&&(delete t.defacs,this._tinode._db.updUser(this.name,t.public)),_(this,t),this._tinode._db.updTopic(this),"me"!==this.name&&!t._noForwarding){const t=this._tinode.getMeTopic();t.onMetaSub&&t.onMetaSub(this),t.onSubsUpdated&&t.onSubsUpdated([this.name],1)}this.onMetaDesc&&this.onMetaDesc(this)},_processMetaSub:function(t){for(let e in t){const n=t[e];n.online=!!n.online,this._lastSubsUpdate=new Date(Math.max(this._lastSubsUpdate,n.updated));let s=null;n.deleted?(delete this._users[n.user],s=n):(this._tinode.isMe(n.user)&&n.acs&&this._processMetaDesc({updated:n.updated,touched:n.touched,acs:n.acs}),s=this._updateCachedUser(n.user,n)),this.onMetaSub&&this.onMetaSub(s)}this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users))},_processMetaTags:function(t){1==t.length&&t[0]==v.DEL_CHAR&&(t=[]),this._tags=t,this.onTagsUpdated&&this.onTagsUpdated(t)},_processMetaCreds:function(t){},_processDelMessages:function(t,e){this._maxDel=Math.max(t,this._maxDel),this.clear=Math.max(t,this.clear);const n=this;let s=0;Array.isArray(e)&&e.forEach((function(t){if(t.hi)for(let e=t.low;e<t.hi;e++)s++,n.flushMessage(e);else s++,n.flushMessage(t.low)})),s>0&&(this._updateDeletedRanges(),this.onData&&this.onData())},_allMessagesReceived:function(t){this._updateDeletedRanges(),this.onAllMessagesReceived&&this.onAllMessagesReceived(t)},_resetSub:function(){this._subscribed=!1},_gone:function(){this._messages.reset(),this._tinode._db.remMessages(this.name),this._users={},this.acs=new t(null),this.private=null,this.public=null,this.trusted=null,this._maxSeq=0,this._minSeq=0,this._subscribed=!1;const e=this._tinode.getMeTopic();e&&e._routePres({_noForwarding:!0,what:"gone",topic:"me",src:this.name}),this.onDeleteTopic&&this.onDeleteTopic()},_updateCachedUser:function(t,e){let n=this._cacheGetUser(t);return n=_(n||{},e),this._cachePutUser(t,n),b(this._users,t,n)},_getQueuedSeqId:function(){return this._queuedSeqId++},_updateDeletedRanges:function(){const t=[];let e=null;const n=this._messages.getAt(0);n&&this._minSeq>1&&!this._noEarlierMsgs?n.hi?(n.seq>1&&(n.seq=1),n.hi<this._minSeq-1&&(n.hi=this._minSeq-1),e=n):(e={seq:1,hi:this._minSeq-1},t.push(e)):e={seq:0,hi:0},this._messages.filter(n=>n.seq>=268435455||(n.seq==(e.hi||e.seq)+1?n.hi&&e.hi?(e.hi=n.hi,!1):(e=n,!0):(e.hi?e.hi=n.hi||n.seq:(e={seq:e.seq+1,hi:n.hi||n.seq},t.push(e)),!n.hi&&(e=n,!0))));const s=this._messages.getLast(),i=Math.max(this.seq,this._maxSeq)||0;(i>0&&!s||s&&(s.hi||s.seq)<i)&&(s&&s.hi?s.hi=i:t.push({seq:s?s.seq+1:1,hi:i})),t.forEach(t=>{t._status=8,this._messages.put(t)})},_loadMessages:function(t,e){const{since:n,before:s,limit:i}=e||{};return t.readMessages(this.name,{since:n,before:s,limit:i||24}).then(t=>(t.forEach(t=>{t.seq>this._maxSeq&&(this._maxSeq=t.seq),(t.seq<this._minSeq||0==this._minSeq)&&(this._minSeq=t.seq),this._messages.put(t)}),t.length>0&&this._updateDeletedRanges(),t.length))},_updateReceived:function(t,e){this.touched=new Date,this.seq=0|t,e&&!this._tinode.isMe(e)||(this.read=this.read?Math.max(this.read,this.seq):this.seq,this.recv=this.recv?Math.max(this.read,this.recv):this.read),this.unread=this.seq-(0|this.read),this._tinode._db.updTopic(this)}};const x=function(t){y.call(this,"me",t),t&&(this.onContactUpdate=t.onContactUpdate)};x.prototype=Object.create(y.prototype,{_processMetaDesc:{value:function(t){const e=t.acs&&!t.acs.isPresencer()&&this.acs&&this.acs.isPresencer();_(this,t),this._tinode._db.updTopic(this),this._updateCachedUser(this._tinode._myUID,t),e&&this._tinode.cacheMap("topic",t=>{t.online&&(t.online=!1,t.seen=Object.assign(t.seen||{},{when:new Date}),this._refreshContact("off",t))}),this.onMetaDesc&&this.onMetaDesc(this)},enumerable:!0,configurable:!0},_processMetaSub:{value:function(t){let e=0;if(t.forEach(t=>{const n=t.topic;if("fnd"==n||"me"==n)return;t.online=!!t.online;let s=null;if(t.deleted)s=t,this._tinode.cacheDel("topic",n),this._tinode._db.remTopic(n);else if(void 0!==t.seq&&(t.seq=0|t.seq,t.recv=0|t.recv,t.read=0|t.read,t.unread=t.seq-t.read),s=_(this._tinode.getTopic(n),t),this._tinode._db.updTopic(s),v.isP2PTopicName(n)&&(this._cachePutUser(n,s),this._tinode._db.updUser(n,s.public)),!t._noForwarding){const e=this._tinode.getTopic(n);e&&(t._noForwarding=!0,e._processMetaDesc(t))}e++,this.onMetaSub&&this.onMetaSub(s)}),this.onSubsUpdated&&e>0){const n=[];t.forEach(t=>{n.push(t.topic)}),this.onSubsUpdated(n,e)}},enumerable:!0,configurable:!0},_processMetaCreds:{value:function(t,e){1==t.length&&t[0]==v.DEL_CHAR&&(t=[]),e?t.forEach(t=>{if(t.val){let e=this._credentials.findIndex(e=>e.meth==t.meth&&e.val==t.val);e<0?(t.done||(e=this._credentials.findIndex(e=>e.meth==t.meth&&!e.done))>=0&&this._credentials.splice(e,1),this._credentials.push(t)):this._credentials[e].done=t.done}else if(t.resp){const e=this._credentials.findIndex(e=>e.meth==t.meth&&!e.done);e>=0&&(this._credentials[e].done=!0)}}):this._credentials=t,this.onCredsUpdated&&this.onCredsUpdated(this._credentials)},enumerable:!0,configurable:!0},_routePres:{value:function(e){if("term"==e.what)return void this._resetSub();if("upd"==e.what&&"me"==e.src)return void this.getMeta(this.startMetaQuery().withDesc().build());const n=this._tinode.cacheGet("topic",e.src);if(n){switch(e.what){case"on":n.online=!0;break;case"off":n.online&&(n.online=!1,n.seen=Object.assign(n.seen||{},{when:new Date}));break;case"msg":n._updateReceived(e.seq,e.act);break;case"upd":this.getMeta(this.startMetaQuery().withLaterOneSub(e.src).build());break;case"acs":n.acs?n.acs.updateAll(e.dacs):n.acs=(new t).updateAll(e.dacs),n.touched=new Date;break;case"ua":n.seen={when:new Date,ua:e.ua};break;case"recv":e.seq=0|e.seq,n.recv=n.recv?Math.max(n.recv,e.seq):e.seq;break;case"read":e.seq=0|e.seq,n.read=n.read?Math.max(n.read,e.seq):e.seq,n.recv=n.recv?Math.max(n.read,n.recv):n.recv,n.unread=n.seq-n.read;break;case"gone":this._tinode.cacheDel("topic",e.src),this._tinode._db.remTopic(e.src);break;case"del":break;default:this._tinode.logger("INFO: Unsupported presence update in 'me'",e.what)}this._refreshContact(e.what,n)}else if("acs"==e.what){const n=new t(e.dacs);if(!n||n.mode==t._INVALID)return void this._tinode.logger("ERROR: Invalid access mode update",e.src,e.dacs);if(n.mode==t._NONE)return void this._tinode.logger("WARNING: Removing non-existent subscription",e.src,e.dacs);{this.getMeta(this.startMetaQuery().withOneSub(void 0,e.src).build());const t=this._tinode.getTopic(e.src);t.topic=e.src,t.online=!1,t.acs=n,this._tinode.attachCacheToTopic(t),t._cachePutSelf(),this._tinode._db.updTopic(t)}}else"tags"==e.what&&this.getMeta(this.startMetaQuery().withTags().build());this.onPres&&this.onPres(e)},enumerable:!0,configurable:!0},_refreshContact:{value:function(t,e){this.onContactUpdate&&this.onContactUpdate(t,e)},enumerable:!0,configurable:!0},publish:{value:function(){return Promise.reject(new Error("Publishing to 'me' is not supported"))},enumerable:!0,configurable:!0},delCredential:{value:function(t,e){return this._subscribed?this._tinode.delCredential(t,e).then(n=>{const s=this._credentials.findIndex(n=>n.meth==t&&n.val==e);return s>-1&&this._credentials.splice(s,1),this.onCredsUpdated&&this.onCredsUpdated(this._credentials),n}):Promise.reject(new Error("Cannot delete credential in inactive 'me' topic"))},enumerable:!0,configurable:!0},contacts:{value:function(t,e,n){this._tinode.cacheMap("topic",(s,i)=>{!s.isCommType()||e&&!e(s)||t.call(n,s,i)})},enumerable:!0,configurable:!0},getContact:{value:function(t){return this._tinode.cacheGet("topic",t)},enumerable:!0,configurable:!0},getAccessMode:{value:function(t){if(t){const e=this._tinode.cacheGet("topic",t);return e?e.acs:null}return this.acs},enumerable:!0,configurable:!0},isArchived:{value:function(t){const e=this._tinode.cacheGet("topic",t);return e&&e.private&&!!e.private.arch},enumerable:!0,configurable:!0},getCredentials:{value:function(){return this._credentials},enumerable:!0,configurable:!0}}),x.prototype.constructor=x;const M=function(t){y.call(this,"fnd",t),this._contacts={}};M.prototype=Object.create(y.prototype,{_processMetaSub:{value:function(t){let e=Object.getOwnPropertyNames(this._contacts).length;this._contacts={};for(let n in t){let s=t[n];const i=s.topic?s.topic:s.user;s=b(this._contacts,i,s),e++,this.onMetaSub&&this.onMetaSub(s)}e>0&&this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._contacts))},enumerable:!0,configurable:!0},publish:{value:function(){return Promise.reject(new Error("Publishing to 'fnd' is not supported"))},enumerable:!0,configurable:!0},setMeta:{value:function(t){const e=this;return Object.getPrototypeOf(M.prototype).setMeta.call(this,t).then((function(){Object.keys(e._contacts).length>0&&(e._contacts={},e.onSubsUpdated&&e.onSubsUpdated([]))}))},enumerable:!0,configurable:!0},contacts:{value:function(t,e){const n=t||this.onMetaSub;if(n)for(let s in this._contacts)n.call(e,this._contacts[s],s,this._contacts)},enumerable:!0,configurable:!0}}),M.prototype.constructor=M,G.exports=v,G.exports.Drafty=f,G.exports.AccessMode=t}).call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{}),G=G.exports}));