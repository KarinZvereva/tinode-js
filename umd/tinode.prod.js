!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Tinode=e()}}((function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;class t{constructor(e){e&&(this.given="number"==typeof e.given?e.given:t.decode(e.given),this.want="number"==typeof e.want?e.want:t.decode(e.want),this.mode=e.mode?"number"==typeof e.mode?e.mode:t.decode(e.mode):this.given&this.want)}static _checkFlag(e,t,n){if(["given","want","mode"].includes(t=t||"mode"))return 0!=(e[t]&n);throw new Error("Invalid AccessMode component '".concat(t,"'"))}static decode(e){if(!e)return null;if("number"==typeof e)return e&t._BITMASK;if("N"===e||"n"===e)return t._NONE;const n={J:t._JOIN,R:t._READ,W:t._WRITE,P:t._PRES,A:t._APPROVE,S:t._SHARE,D:t._DELETE,O:t._OWNER};let r=t._NONE;for(let t=0;t<e.length;t++){const i=n[e.charAt(t).toUpperCase()];i&&(r|=i)}return r}static encode(e){if(null===e||e===t._INVALID)return null;if(e===t._NONE)return"N";const n=["J","R","W","P","A","S","D","O"];let r="";for(let t=0;t<n.length;t++)0!=(e&1<<t)&&(r+=n[t]);return r}static update(e,n){if(!n||"string"!=typeof n)return e;let r=n.charAt(0);if("+"==r||"-"==r){let i=e;const o=n.split(/([-+])/);for(let n=1;n<o.length-1;n+=2){r=o[n];const s=t.decode(o[n+1]);if(s==t._INVALID)return e;null!=s&&("+"===r?i|=s:"-"===r&&(i&=~s))}e=i}else{const r=t.decode(n);r!=t._INVALID&&(e=r)}return e}static diff(e,n){return e=t.decode(e),n=t.decode(n),e==t._INVALID||n==t._INVALID?t._INVALID:e&~n}toString(){return'{"mode": "'+t.encode(this.mode)+'", "given": "'+t.encode(this.given)+'", "want": "'+t.encode(this.want)+'"}'}jsonHelper(){return{mode:t.encode(this.mode),given:t.encode(this.given),want:t.encode(this.want)}}setMode(e){return this.mode=t.decode(e),this}updateMode(e){return this.mode=t.update(this.mode,e),this}getMode(){return t.encode(this.mode)}setGiven(e){return this.given=t.decode(e),this}updateGiven(e){return this.given=t.update(this.given,e),this}getGiven(){return t.encode(this.given)}setWant(e){return this.want=t.decode(e),this}updateWant(e){return this.want=t.update(this.want,e),this}getWant(){return t.encode(this.want)}getMissing(){return t.encode(this.want&~this.given)}getExcessive(){return t.encode(this.given&~this.want)}updateAll(e){return e&&(this.updateGiven(e.given),this.updateWant(e.want),this.mode=this.given&this.want),this}isOwner(e){return t._checkFlag(this,e,t._OWNER)}isPresencer(e){return t._checkFlag(this,e,t._PRES)}isMuted(e){return!this.isPresencer(e)}isJoiner(e){return t._checkFlag(this,e,t._JOIN)}isReader(e){return t._checkFlag(this,e,t._READ)}isWriter(e){return t._checkFlag(this,e,t._WRITE)}isApprover(e){return t._checkFlag(this,e,t._APPROVE)}isAdmin(e){return this.isOwner(e)||this.isApprover(e)}isSharer(e){return this.isAdmin(e)||t._checkFlag(this,e,t._SHARE)}isDeleter(e){return t._checkFlag(this,e,t._DELETE)}}e.default=t,t._NONE=0,t._JOIN=1,t._READ=2,t._WRITE=4,t._PRES=8,t._APPROVE=16,t._SHARE=32,t._DELETE=64,t._OWNER=128,t._BITMASK=t._JOIN|t._READ|t._WRITE|t._PRES|t._APPROVE|t._SHARE|t._DELETE|t._OWNER,t._INVALID=1048576;var n={};function r(t,n,i){if("object"!=typeof n){if(n===Tinode.DEL_CHAR)return;return void 0===n?t:n}if(null===n)return n;if(n instanceof Date&&!isNaN(n))return!t||!(t instanceof Date)||isNaN(t)||t<n?n:t;if(n instanceof e)return new e(n);if(n instanceof Array)return n;t&&t!==Tinode.DEL_CHAR||(t=n.constructor());for(let e in n)!n.hasOwnProperty(e)||i&&i[e]||"_noForwarding"==e||(t[e]=r(t[e],n[e]));return t}Object.defineProperty(n,"__esModule",{value:!0}),n.jsonParseHelper=function(t,n){if("string"==typeof n&&n.length>=20&&n.length<=24&&["ts","touched","updated","created","when","deleted","expires"].includes(t)){const e=new Date(n);if(!isNaN(e))return e}else if("acs"===t&&"object"==typeof n)return new e(n);return n},n.mergeObj=r,n.simplify=function e(t){return Object.keys(t).forEach(n=>{"_"==n[0]?delete t[n]:t[n]?Array.isArray(t[n])&&0==t[n].length?delete t[n]:t[n]?t[n]instanceof Date?isValidDate(t[n])||delete t[n]:"object"==typeof t[n]&&(e(t[n]),0==Object.getOwnPropertyNames(t[n]).length&&delete t[n]):delete t[n]:delete t[n]}),t};var i={};Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;const{jsonParseHelper:o}=n;let s,a;function c(e,t,n,r){let i=null;return["http","https","ws","wss"].includes(t)&&("/"!==(i="".concat(t,"://").concat(e)).charAt(i.length-1)&&(i+="/"),i+="v"+n+"/channels",["http","https"].includes(t)&&(i+="/lp"),i+="?apikey="+r),i}class u{constructor(e,t,n){let r=e.host;const i=e.secure,l=e.apiKey,d=t,h=n;let f=null,p=0,g=!1;const m=function(e){if(u.logger){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];u.logger(e,...n)}};function _(){clearTimeout(f);const e=Math.pow(2,p)*(1+.3*Math.random())*2e3;p=p>=10?p:p+1,this.onAutoreconnectIteration&&this.onAutoreconnectIteration(e),f=setTimeout(()=>{if(m("Reconnecting, iter=".concat(p,", timeout=").concat(e)),g)this.onAutoreconnectIteration&&this.onAutoreconnectIteration(-1);else{const e=this.connect();this.onAutoreconnectIteration?this.onAutoreconnectIteration(0,e):e.catch(()=>{})}},e)}function y(){clearTimeout(f),f=null}let b=!1;if("lp"===e.transport?(function(e){let t=null,n=null,s=null;e.connect=function(s,u){if(g=!1,n){if(!u)return Promise.resolve();n.onreadystatechange=void 0,n.abort(),n=null}return s&&(r=s),new Promise((function(s,u){const f=c(r,i?"https":"http",d,l);m("Connecting to:",f),(n=function n(r,i,s){let c=new a,u=!1;return c.onreadystatechange=function(a){if(4==c.readyState)if(201==c.status){let s=JSON.parse(c.responseText,o);t=r+"&sid="+s.ctrl.params.sid,(c=n(t)).send(null),e.onOpen&&e.onOpen(),i&&(u=!0,i()),h&&y()}else if(c.status<400)e.onMessage&&e.onMessage(c.responseText),(c=n(t)).send(null);else{if(s&&!u&&(u=!0,s(c.responseText)),e.onMessage&&c.responseText&&e.onMessage(c.responseText),e.onDisconnect){const t=c.status||(g?418:503),n=c.responseText||(g?"Disconnected by client":"Connection failed");e.onDisconnect(new Error(n+" ("+t+")"),t)}c=null,!g&&h&&_.call(e)}},c.open("GET",r,!0),c}(f,s,u)).send(null)})).catch(e=>{m("LP connection failed:",e)})},e.reconnect=function(t){y(),e.connect(null,t)},e.disconnect=function(){g=!0,y(),s&&(s.onreadystatechange=void 0,s.abort(),s=null),n&&(n.onreadystatechange=void 0,n.abort(),n=null),e.onDisconnect&&e.onDisconnect(new Error("Disconnected by client (418)"),418),t=null},e.sendText=function(e){if(!(s=function(e){const t=new a;return t.onreadystatechange=function(e){if(4==t.readyState&&t.status>=400)throw new Error("LP sender failed, ".concat(t.status))},t.open("POST",e,!0),t}(t))||1!=s.readyState)throw new Error("Long poller failed to connect");s.send(e)},e.isConnected=function(){return n&&!0},e.transport=function(){return"lp"},e.probe=function(){e.sendText("1")}}(this),b=!0):"ws"===e.transport&&(function(e){let t=null;e.connect=function(n,o){if(g=!1,t){if(!o&&t.readyState==t.OPEN)return Promise.resolve();t.close(),t=null}return n&&(r=n),new Promise((function(n,o){const a=c(r,i?"wss":"ws",d,l);m("Connecting to: ",a);const u=new s(a);u.onerror=function(e){o(e)},u.onopen=function(t){h&&y(),e.onOpen&&e.onOpen(),n()},u.onclose=function(n){if(t=null,e.onDisconnect){const t=g?418:503;e.onDisconnect(new Error(g?"Disconnected by client":"Connection failed ("+t+")"),t)}!g&&h&&_.call(e)},u.onmessage=function(t){e.onMessage&&e.onMessage(t.data)},t=u}))},e.reconnect=function(t){y(),e.connect(null,t)},e.disconnect=function(){g=!0,y(),t&&(t.close(),t=null)},e.sendText=function(e){if(!t||t.readyState!=t.OPEN)throw new Error("Websocket is not connected");t.send(e)},e.isConnected=function(){return t&&t.readyState==t.OPEN},e.transport=function(){return"ws"},e.probe=function(){e.sendText("1")}}(this),b=!0),!b)throw m("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'."),new Error("Unknown or invalid network transport. Running under Node? Call 'Tinode.setNetworkProviders()'.");this.backoffReset=function(){p=0},this.onMessage=void 0,this.onDisconnect=void 0,this.onOpen=void 0,this.onAutoreconnectIteration=void 0,this.logger=void 0}static setNetworkProviders(e,t){s=e,a=t}}i.default=u,u.NETWORK_ERROR=503,u.NETWORK_ERROR_TEXT="Connection failed",u.NETWORK_USER=418,u.NETWORK_USER_TEXT="Disconnected by client";var l={};Object.defineProperty(l,"__esModule",{value:!0}),l.default=void 0;let d;l.default=class{constructor(e,t){e=e||function(){},t=t||function(){};let n=null,r=!1;const i=["created","updated","deleted","read","recv","seq","clear","defacs","creds","public","trusted","private","touched"];function o(e,t){const n=e||{name:t.name};return i.forEach(e=>{t.hasOwnProperty(e)&&(n[e]=t[e])}),Array.isArray(t._tags)&&(n.tags=t._tags),t.acs&&(n.acs=t.getAccessMode().jsonHelper()),n}function s(e,t){const n=e||{};return["topic","seq","ts","_status","from","head","content"].forEach(e=>{t.hasOwnProperty(e)&&(n[e]=t[e])}),n}function a(e,i,o){return n?new Promise((r,s)=>{const a=n.transaction([e]);a.onerror=n=>{t("PCache","mapObjects",e,n.target.error),s(n.target.error)},a.objectStore(e).getAll().onsuccess=e=>{i&&e.target.result.forEach(e=>{i.call(o,e)}),r(e.target.result)}}):r?Promise.resolve([]):Promise.reject(new Error("not initialized"))}return{initDatabase:function(){return new Promise((i,o)=>{const s=d.open("tinode-web",1);s.onsuccess=e=>{n=e.target.result,r=!1,i(n)},s.onerror=n=>{t("PCache","failed to initialize",n),o(n.target.error),e(n.target.error)},s.onupgradeneeded=function(r){(n=r.target.result).onerror=function(n){t("PCache","failed to create storage",n),e(n.target.error)},n.createObjectStore("topic",{keyPath:"name"}),n.createObjectStore("user",{keyPath:"uid"}),n.createObjectStore("subscription",{keyPath:["topic","uid"]}),n.createObjectStore("message",{keyPath:["topic","seq"]})}})},deleteDatabase:function(){return new Promise((e,i)=>{const o=d.deleteDatabase("tinode-web");o.onblocked=function(e){n&&n.close()},o.onsuccess=t=>{n=null,r=!0,e(!0)},o.onerror=e=>{t("PCache","deleteDatabase",e.target.error),i(e.target.error)}})},isReady:function(){return!!n},updTopic:function(e){return this.isReady()?new Promise((r,i)=>{const s=n.transaction(["topic"],"readwrite");s.oncomplete=e=>{r(e.target.result)},s.onerror=e=>{t("PCache","updTopic",e.target.error),i(e.target.error)};const a=s.objectStore("topic").get(e.name);a.onsuccess=t=>{s.objectStore("topic").put(o(a.result,e)),s.commit()}}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},markTopicAsDeleted:function(e,i){return this.isReady()?new Promise((r,s)=>{const a=n.transaction(["topic"],"readwrite");a.oncomplete=e=>{r(e.target.result)},a.onerror=e=>{t("PCache","markTopicAsDeleted",e.target.error),s(e.target.error)};const c=a.objectStore("topic").get(e);c.onsuccess=e=>{const t=e.target.result;t._deleted!=i&&(t._deleted=!0,a.objectStore("topic").put(o(c.result,t))),a.commit()}}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},remTopic:function(e){return this.isReady()?new Promise((r,i)=>{const o=n.transaction(["topic","subscription","message"],"readwrite");o.oncomplete=e=>{r(e.target.result)},o.onerror=e=>{t("PCache","remTopic",e.target.error),i(e.target.error)},o.objectStore("topic").delete(IDBKeyRange.only(e)),o.objectStore("subscription").delete(IDBKeyRange.bound([e,"-"],[e,"~"])),o.objectStore("message").delete(IDBKeyRange.bound([e,0],[e,Number.MAX_SAFE_INTEGER])),o.commit()}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},mapTopics:function(e,t){return a("topic",e,t)},deserializeTopic:function(e,t){!function(e,t){i.forEach(n=>{t.hasOwnProperty(n)&&(e[n]=t[n])}),Array.isArray(t.tags)&&(e._tags=t.tags),t.acs&&e.setAccessMode(t.acs),e.seq|=0,e.read|=0,e.unread=Math.max(0,e.seq-e.read)}(e,t)},updUser:function(e,i){if(!(arguments.length<2||void 0===i))return this.isReady()?new Promise((r,o)=>{const s=n.transaction(["user"],"readwrite");s.oncomplete=e=>{r(e.target.result)},s.onerror=e=>{t("PCache","updUser",e.target.error),o(e.target.error)},s.objectStore("user").put({uid:e,public:i}),s.commit()}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},remUser:function(e){return this.isReady()?new Promise((r,i)=>{const o=n.transaction(["user"],"readwrite");o.oncomplete=e=>{r(e.target.result)},o.onerror=e=>{t("PCache","remUser",e.target.error),i(e.target.error)},o.objectStore("user").delete(IDBKeyRange.only(e)),o.commit()}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},mapUsers:function(e,t){return a("user",e,t)},getUser:function(e){return this.isReady()?new Promise((r,i)=>{const o=n.transaction(["user"]);o.oncomplete=e=>{const t=e.target.result;r({user:t.uid,public:t.public})},o.onerror=e=>{t("PCache","getUser",e.target.error),i(e.target.error)},o.objectStore("user").get(e)}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},updSubscription:function(e,i,o){return this.isReady()?new Promise((r,s)=>{const a=n.transaction(["subscription"],"readwrite");a.oncomplete=e=>{r(e.target.result)},a.onerror=e=>{t("PCache","updSubscription",e.target.error),s(e.target.error)},a.objectStore("subscription").get([e,i]).onsuccess=t=>{a.objectStore("subscription").put(function(e,t,n,r){const i=e||{topic:t,uid:n};return["updated","mode","read","recv","clear","lastSeen","userAgent"].forEach(e=>{r.hasOwnProperty(e)&&(i[e]=r[e])}),i}(t.target.result,e,i,o)),a.commit()}}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},mapSubscriptions:function(e,i,o){return this.isReady()?new Promise((r,s)=>{const a=n.transaction(["subscription"]);a.onerror=e=>{t("PCache","mapSubscriptions",e.target.error),s(e.target.error)},a.objectStore("subscription").getAll(IDBKeyRange.bound([e,"-"],[e,"~"])).onsuccess=e=>{i&&e.target.result.forEach(e=>{i.call(o,e)}),r(e.target.result)}}):r?Promise.resolve([]):Promise.reject(new Error("not initialized"))},addMessage:function(e){return this.isReady()?new Promise((r,i)=>{const o=n.transaction(["message"],"readwrite");o.onsuccess=e=>{r(e.target.result)},o.onerror=e=>{t("PCache","addMessage",e.target.error),i(e.target.error)},o.objectStore("message").add(s(null,e)),o.commit()}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},updMessageStatus:function(e,i,o){return this.isReady()?new Promise((r,a)=>{const c=n.transaction(["message"],"readwrite");c.onsuccess=e=>{r(e.target.result)},c.onerror=e=>{t("PCache","updMessageStatus",e.target.error),a(e.target.error)};const u=c.objectStore("message").get(IDBKeyRange.only([e,i]));u.onsuccess=t=>{const n=u.result||t.target.result;n&&n._status!=o?(c.objectStore("message").put(s(n,{topic:e,seq:i,_status:o})),c.commit()):c.commit()}}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},remMessages:function(e,i,o){return this.isReady()?new Promise((r,s)=>{i||o||(i=0,o=Number.MAX_SAFE_INTEGER);const a=o>0?IDBKeyRange.bound([e,i],[e,o],!1,!0):IDBKeyRange.only([e,i]),c=n.transaction(["message"],"readwrite");c.onsuccess=e=>{r(e.target.result)},c.onerror=e=>{t("PCache","remMessages",e.target.error),s(e.target.error)},c.objectStore("message").delete(a),c.commit()}):r?Promise.resolve():Promise.reject(new Error("not initialized"))},readMessages:function(e,i,o,s){return this.isReady()?new Promise((r,a)=>{const c=(i=i||{}).since>0?i.since:0,u=i.before>0?i.before:Number.MAX_SAFE_INTEGER,l=0|i.limit,d=[],h=IDBKeyRange.bound([e,c],[e,u],!1,!0),f=n.transaction(["message"]);f.onerror=e=>{t("PCache","readMessages",e.target.error),a(e.target.error)},f.objectStore("message").openCursor(h,"prev").onsuccess=e=>{const t=e.target.result;t?(o&&o.call(s,t.value),d.push(t.value),l<=0||d.length<l?t.continue():r(d)):r(d)}}):r?Promise.resolve([]):Promise.reject(new Error("not initialized"))}}}static setDatabaseProvider(e){d=e}};var h={exports:{}};const f=["act","height","mime","name","ref","size","url","val","width"],p=[{name:"ST",start:/(?:^|[\W_])(\*)[^\s*]/,end:/[^\s*](\*)(?=$|[\W_])/},{name:"EM",start:/(?:^|\W)(_)[^\s_]/,end:/[^\s_](_)(?=$|\W)/},{name:"DL",start:/(?:^|[\W_])(~)[^\s~]/,end:/[^\s~](~)(?=$|[\W_])/},{name:"CO",start:/(?:^|\W)(`)[^`]/,end:/[^`](`)(?=$|\W)/}],g=["QQ"],m=[{name:"LN",dataName:"url",pack:function(e){return/^[a-z]+:\/\//i.test(e)||(e="http://"+e),{url:e}},re:/(?:(?:https?|ftp):\/\/|www\.|ftp\.)[-A-Z0-9+&@#\/%=~_|$?!:,.]*[A-Z0-9+&@#\/%=~_|$]/gi},{name:"MN",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B@([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu},{name:"HT",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B#([\p{L}\p{N}][._\p{L}\p{N}]*[\p{L}\p{N}])/gu}],_={BN:{name:"button",isVoid:!1},BR:{name:"br",isVoid:!0},CO:{name:"tt",isVoid:!1},DL:{name:"del",isVoid:!1},EM:{name:"i",isVoid:!1},EX:{name:"",isVoid:!0},FM:{name:"div",isVoid:!1},HD:{name:"",isVoid:!1},HL:{name:"span",isVoid:!1},HT:{name:"a",isVoid:!1},IM:{name:"img",isVoid:!1},LN:{name:"a",isVoid:!1},MN:{name:"a",isVoid:!1},RW:{name:"div",isVoid:!1},QQ:{name:"div",isVoid:!1},ST:{name:"b",isVoid:!1}};function y(e,t,n){if(!e)return null;try{const n=atob(e),r=n.length,i=new ArrayBuffer(r),o=new Uint8Array(i);for(let e=0;e<r;e++)o[e]=n.charCodeAt(e);return URL.createObjectURL(new Blob([i],{type:t}))}catch(r){n&&n("Drafty: failed to convert object.",r.message)}return null}function b(e,t){return e?"data:"+(t=t||"image/jpeg")+";base64,"+e:null}const w={ST:{open:function(){return"<b>"},close:function(){return"</b>"}},EM:{open:function(){return"<i>"},close:function(){return"</i>"}},DL:{open:function(){return"<del>"},close:function(){return"</del>"}},CO:{open:function(){return"<tt>"},close:function(){return"</tt>"}},BR:{open:function(){return"<br/>"},close:function(){return""}},HD:{open:function(){return""},close:function(){return""}},HL:{open:function(){return'<span style="color:teal">'},close:function(){return"</span>"}},LN:{open:function(e){return'<a href="'+e.url+'">'},close:function(e){return"</a>"},props:function(e){return e?{href:e.url,target:"_blank"}:null}},MN:{open:function(e){return'<a href="#'+e.val+'">'},close:function(e){return"</a>"},props:function(e){return e?{id:e.val}:null}},HT:{open:function(e){return'<a href="#'+e.val+'">'},close:function(e){return"</a>"},props:function(e){return e?{id:e.val}:null}},BN:{open:function(e){return"<button>"},close:function(e){return"</button>"},props:function(e){return e?{"data-act":e.act,"data-val":e.val,"data-name":e.name,"data-ref":e.ref}:null}},IM:{open:function(e){const t=b(e._tempPreview,e.mime),n=y(e.val,e.mime,v.logger),r=e.ref||n;return(e.name?'<a href="'+r+'" download="'+e.name+'">':"")+'<img src="'+(t||n)+'"'+(e.width?' width="'+e.width+'"':"")+(e.height?' height="'+e.height+'"':"")+' border="0" />'},close:function(e){return e.name?"</a>":""},props:function(e){return e?{src:b(e._tempPreview,e.mime)||e.ref||y(e.val,e.mime,v.logger),title:e.name,alt:e.name,"data-width":e.width,"data-height":e.height,"data-name":e.name,"data-size":e.val?.75*e.val.length|0:0|e.size,"data-mime":e.mime}:null}},FM:{open:function(e){return"<div>"},close:function(e){return"</div>"}},RW:{open:function(e){return"<div>"},close:function(e){return"</div>"}},QQ:{open:function(e){return"<div>"},close:function(e){return"</div>"},props:function(e){return e?{}:null}}},v=function(){this.txt="",this.fmt=[],this.ent=[]};function E(e){if(!e)return null;e="string"==typeof e?{txt:e}:e;let{txt:t,fmt:n,ent:r}=e;if(t=t||"",Array.isArray(r)||(r=[]),!Array.isArray(n)||0==n.length){if(0==r.length)return{text:t};n=[{at:0,len:0,key:0}]}const i=[],o=[];n.forEach(e=>{if(!["undefined","number"].includes(typeof e.at))return;if(!["undefined","number"].includes(typeof e.len))return;let n=0|e.at,s=0|e.len;if(s<0)return;let a=e.key||0;r.length>0&&("number"!=typeof a||a<0||a>=r.length)||(n<=-1?o.push({start:-1,end:0,key:a}):n+s>t.length||(e.tp?i.push({type:e.tp,start:n,end:n+s}):r.length>0&&"object"==typeof r[a]&&i.push({start:n,end:n+s,key:a})))}),i.sort((e,t)=>{let n=e.start-t.start;return 0!=n||0!=(n=t.end-e.end)?n:g.indexOf(t.type)-g.indexOf(e.type)}),o.length>0&&i.push(...o),i.forEach(e=>{r.length>0&&!e.type&&(e.type=r[e.key].tp,e.data=r[e.key].data),e.type||(e.type="HD")});let s=function e(t,n,r,i,o){if(!o||0==o.length)return r<i&&P(t,{text:n.substring(r,i)}),t;for(let s=0;s<o.length;s++){const i=o[s];if(i.start<0&&"EX"==i.type){P(t,{type:i.type,data:i.data,key:i.key,att:!0});continue}r<i.start&&(P(t,{text:n.substring(r,i.start)}),r=i.start);const a=[];for(;s<o.length-1;){const e=o[s+1];if(e.start<0)break;if(!(e.start<i.end))break;if(e.end<=i.end){const t=_[e.tp]||{};(e.start<e.end||t.isVoid)&&a.push(e)}s++}P(t,e({type:i.type,data:i.data,key:i.key},n,r,i.end,a)),r=i.end}return r<i&&P(t,{text:n.substring(r,i)}),t}({},t,0,t.length,i);return x(s,(function(e){if(Array.isArray(e.children)&&1==e.children.length){const t=e.children[0];if(e.type)t.type||t.children||(e.text=t.text,delete e.children);else{const n=e.parent;(e=t).parent=n}}return e}))}function P(e,t){return t?(e.children||(e.children=[]),e.text&&(e.children.push({text:e.text,parent:e}),delete e.text),t.parent=e,e.children.push(t),e):e}function T(e,t,n){if(!t)return e;e.txt=e.txt||"";const r=e.txt.length;if(t.text?e.txt+=t.text:Array.isArray(t.children)&&t.children.forEach(t=>{T(e,t,n)}),t.type){const i=e.txt.length-r;if(e.fmt=e.fmt||[],Object.keys(t.data||{}).length>0){e.ent=e.ent||[];const o=void 0===n[t.key]?e.ent.length:n[t.key];n[t.key]=o,e.ent[o]={tp:t.type,data:t.data},t.att?e.fmt.push({at:-1,len:0,key:o}):e.fmt.push({at:r,len:i,key:o})}else e.fmt.push({tp:t.type,at:r,len:i})}return e}function x(e,t,n){if(!e)return null;let r=t.call(n,e);if(!r||!r.children)return r;const i=[];for(let o in r.children){let e=r.children[o];e&&(e=x(e,t,n))&&i.push(e)}return 0==i.length?r.children=null:r.children=i,r}function S(e,t,n,r,i){if(!e)return null;r&&e.type&&r.push(e.type);let o=[];for(let s in e.children){const n=S(e.children[s],t,s,r,i);n&&o.push(n)}return 0==o.length&&(o=e.text?[e.text]:null),r&&e.type&&r.pop(),t.call(i,e.type,e.data,o,n,r)}function R(e,t,n){return e?(n&&(t-=n.length),x(e,(function(e){if(t<=-1)return null;if(e.att)return e;if(0==t)e.text=n,t=-1;else if(e.text){const r=e.text.length;r>t?(e.text=e.text.substring(0,t)+n,t=-1):t-=r}return e}))):null}function A(e){return x(e,(function(e){const t=M(e.data,!0);return t?e.data=t:delete e.data,e}))}function k(e,t){if(!e)return null;if(e.att)e.text=" ",delete e.att,delete e.children;else if(e.children){const n=[],r=[];for(let i in e.children){const o=e.children[i];if(o.att){if(n.length==t)continue;if("application/json"==o.data.mime)continue;delete o.att,delete o.children,o.text=" ",n.push(o)}else r.push(o)}e.children=r.concat(n)}return e}function M(e,t,n){if(e&&Object.entries(e).length>0){n=n||[];const r={};if(f.forEach(i=>{if(e[i]){if(t&&!n.includes(i)&&("string"==typeof e[i]||Array.isArray(e[i]))&&e[i].length>64)return;if("object"==typeof e[i])return;r[i]=e[i]}}),0!=Object.entries(r).length)return r}return null}v.init=function(e){if(void 0===e)e="";else if("string"!=typeof e)return null;return{txt:e}},v.parse=function(e){if("string"!=typeof e)return null;const t=e.split(/\r?\n/),n=[],r={},i=[];t.forEach(e=>{let t,o,s=[];if(p.forEach(t=>{s=s.concat(function(e,t,n,r){const i=[];let o=0,s=e.slice(0);for(;s.length>0;){const a=t.exec(s);if(null==a)break;let c=a.index+a[0].lastIndexOf(a[1]);s=s.slice(c+1),o=(c+=o)+1;const u=n?n.exec(s):null;if(null==u)break;let l=u.index+u[0].indexOf(u[1]);s=s.slice(l+1),o=(l+=o)+1,i.push({txt:e.slice(c+1,l),children:[],at:c,end:l,tp:r})}return i}(e,t.start,t.end,t.name))}),0==s.length)o={txt:e};else{s.sort((e,t)=>{const n=e.at-t.at;return 0!=n?n:t.end-e.end}),s=function e(t){if(0==t.length)return[];const n=[t[0]];let r=t[0];for(let i=1;i<t.length;i++)t[i].at>r.end?(n.push(t[i]),r=t[i]):t[i].end<=r.end&&r.children.push(t[i]);for(let i in n)n[i].children=e(n[i].children);return n}(s);const t=function e(t,n){let r="",i=[];for(let o in t){const s=t[o];if(!s.txt){const t=e(s.children,r.length+n);s.txt=t.txt,i=i.concat(t.fmt)}s.tp&&i.push({at:r.length+n,len:s.txt.length,tp:s.tp}),r+=s.txt}return{txt:r,fmt:i}}(function e(t,n,r,i){const o=[];if(0==i.length)return[];for(let s in i){const r=i[s];r.at>n&&o.push({txt:t.slice(n,r.at)});const a={tp:r.tp},c=e(t,r.at+1,r.end,r.children);c.length>0?a.children=c:a.txt=r.txt,o.push(a),n=r.end+1}return n<r&&o.push({txt:t.slice(n,r)}),o}(e,0,e.length,s),0);o={txt:t.txt,fmt:t.fmt}}if((t=function(e){let t,n=[];if(m.forEach(r=>{for(;null!==(t=r.re.exec(e));)n.push({offset:t.index,len:t[0].length,unique:t[0],data:r.pack(t[0]),type:r.name})}),0==n.length)return n;n.sort((e,t)=>e.offset-t.offset);let r=-1;return n=n.filter(e=>{const t=e.offset>r;return r=e.offset+e.len,t})}(o.txt)).length>0){const e=[];for(let i in t){const o=t[i];let s=r[o.unique];s||(s=n.length,r[o.unique]=s,n.push({tp:o.type,data:o.data})),e.push({at:o.offset,len:o.len,key:s})}o.ent=e}i.push(o)});const o={txt:""};if(i.length>0){o.txt=i[0].txt,o.fmt=(i[0].fmt||[]).concat(i[0].ent||[]);for(let e=1;e<i.length;e++){const t=i[e],n=o.txt.length+1;o.fmt.push({tp:"BR",len:1,at:n-1}),o.txt+=" "+t.txt,t.fmt&&(o.fmt=o.fmt.concat(t.fmt.map(e=>(e.at+=n,e)))),t.ent&&(o.fmt=o.fmt.concat(t.ent.map(e=>(e.at+=n,e))))}0==o.fmt.length&&delete o.fmt,n.length>0&&(o.ent=n)}return o},v.append=function(e,t){if(!e)return t;if(!t)return e;e.txt=e.txt||"";const n=e.txt.length;return"string"==typeof t?e.txt+=t:t.txt&&(e.txt+=t.txt),Array.isArray(t.fmt)&&(e.fmt=e.fmt||[],Array.isArray(t.ent)&&(e.ent=e.ent||[]),t.fmt.forEach(r=>{const i={at:(0|r.at)+n,len:0|r.len};-1==r.at&&(i.at=-1,i.len=0),r.tp?i.tp=r.tp:(i.key=e.ent.length,e.ent.push(t.ent[r.key||0])),e.fmt.push(i)})),e},v.insertImage=function(e,t,n){(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:1,key:e.ent.length});const r={tp:"IM",data:{mime:n.mime,val:n.preview,width:n.width,height:n.height,name:n.filename,size:0|n.size,ref:n.refurl}};return n.urlPromise&&(r.data._tempPreview=n._tempPreview,r.data._processing=!0,n.urlPromise.then(e=>{r.data.ref=e,r.data._tempPreview=void 0,r.data._processing=void 0},e=>{r.data._processing=void 0})),e.ent.push(r),e},v.quote=function(e,t,n){const r=v.append(v.appendLineBreak(v.mention(e,t)),n);return r.fmt.push({at:0,len:r.txt.length,tp:"QQ"}),r},v.mention=function(e,t){return{txt:e||"",fmt:[{at:0,len:(e||"").length,key:0}],ent:[{tp:"MN",data:{val:t}}]}},v.appendLink=function(e,t){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:e.txt.length,len:t.txt.length,key:e.ent.length}),e.txt+=t.txt;const n={tp:"LN",data:{url:t.url}};return e.ent.push(n),e},v.appendImage=function(e,t){return(e=e||{txt:""}).txt+=" ",v.insertImage(e,e.txt.length-1,t)},v.attachFile=function(e,t){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length});const n={tp:"EX",data:{mime:t.mime,val:t.data,name:t.filename,ref:t.refurl,size:0|t.size}};return t.urlPromise&&(n.data._processing=!0,t.urlPromise.then(e=>{n.data.ref=e,n.data._processing=void 0},e=>{n.data._processing=void 0})),e.ent.push(n),e},v.wrapInto=function(e,t,n,r){return"string"==typeof e&&(e={txt:e}),e.fmt=e.fmt||[],e.fmt.push({at:n||0,len:r||e.txt.length,tp:t}),e},v.wrapAsForm=function(e,t,n){return v.wrapInto(e,"FM",t,n)},v.insertButton=function(e,t,n,r,i,o,s){return"string"==typeof e&&(e={txt:e}),!e||!e.txt||e.txt.length<t+n||n<=0||-1==["url","pub"].indexOf(i)?null:"url"!=i||s?(s=""+s,e.ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:0|t,len:n,key:e.ent.length}),e.ent.push({tp:"BN",data:{act:i,val:o,ref:s,name:r}}),e):null},v.appendButton=function(e,t,n,r,i,o){const s=(e=e||{txt:""}).txt.length;return e.txt+=t,v.insertButton(e,s,t.length,n,r,i,o)},v.attachJSON=function(e,t){return(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length}),e.ent.push({tp:"EX",data:{mime:"application/json",val:t}}),e},v.appendLineBreak=function(e){return(e=e||{txt:""}).fmt=e.fmt||[],e.fmt.push({at:e.txt.length,len:1,tp:"BR"}),e.txt+=" ",e},v.UNSAFE_toHTML=function(e){return S(E(e),(function(e,t,n){const r=w[e];let i=n?n.join(""):"";return r&&(i=r.open(t)+i+r.close(t)),i}),0)},v.format=function(e,t,n){return S(E(e),t,0,[],n)},v.shorten=function(e,t,n){let r=E(e);return(r=R(r,t,"\u2026"))&&n&&(r=A(r)),T({},r,[])},v.forwardedContent=function(e){let t=E(e);return T({},t=function e(t){if("BR"==t.type)t=null;else if(t.text)t.type||(t.text=t.text.trimStart(),t.text||(t=null));else if(t.children&&t.children.length>0){const n=e(t.children[0]);n?t.children[0]=n:(t.children.shift(),t.type||0!=t.children.length||(t=null))}return t}(t=x(t,(function(e){return"MN"!=e.type||e.parent&&e.parent.type?e:null}))),[])},v.replyContent=function(e,t){let n=E(e);return n?(n=x(n,(function(e){return"QQ"==e.type?null:("MN"==e.type?e.parent&&e.parent.type||!(e.text||"").startsWith("\u27a6")||(e.text="\u27a6",delete e.children,delete e.data):"BR"==e.type&&(e.text=" ",delete e.type,delete e.children),e)})),T({},n=x(n=R(n=k(n,3),t,"\u2026"),e=>{const t=M(e.data,!0,"IM"==e.type?["val"]:null);return t?e.data=t:delete e.data,e}),[])):e},v.preview=function(e,t){let n=E(e);return T({},n=A(n=R(n=x(n=k(n,3),(function(e){return"MN"==e.type?e.parent&&e.parent.type||!(e.text||"").startsWith("\u27a6")||(e.text="\u27a6",delete e.children):"QQ"==e.type?(e.text=" ",delete e.children):"BR"==e.type&&(e.text=" ",delete e.children,delete e.type),e})),t,"\u2026")),[])},v.toPlainText=function(e){return"string"==typeof e?e:e.txt},v.isPlainText=function(e){return"string"==typeof e||!(e.fmt||e.ent)},v.isValid=function(e){if(!e)return!1;const{txt:t,fmt:n,ent:r}=e;if(!t&&""!==t&&!n&&!r)return!1;const i=typeof t;return!("string"!=i&&"undefined"!=i&&null!==t||void 0!==n&&!Array.isArray(n)&&null!==n||void 0!==r&&!Array.isArray(r)&&null!==r)},v.hasAttachments=function(e){if(!Array.isArray(e.fmt))return!1;for(let t in e.fmt){const n=e.fmt[t];if(n&&n.at<0){const t=e.ent[0|n.key];return t&&"EX"==t.tp&&t.data}}return!1},v.attachments=function(e,t,n){if(!Array.isArray(e.fmt))return;let r=0;e.fmt.forEach(i=>{if(i&&i.at<0){const o=e.ent[0|i.key];o&&"EX"==o.tp&&o.data&&t.call(n,o.data,r++,"EX")}})},v.hasEntities=function(e){return e.ent&&e.ent.length>0},v.entities=function(e,t,n){if(e.ent&&e.ent.length>0)for(let r in e.ent)e.ent[r]&&t.call(n,e.ent[r].data,r,e.ent[r].tp)},v.sanitizeEntities=function(e){if(e&&e.ent&&e.ent.length>0)for(let t in e.ent){const n=e.ent[t];if(n&&n.data){const r=M(n.data);r?e.ent[t].data=r:delete e.ent[t].data}}return e},v.getDownloadUrl=function(e){let t=null;return"application/json"!=e.mime&&e.val?t=y(e.val,e.mime,v.logger):"string"==typeof e.ref&&(t=e.ref),t},v.isProcessing=function(e){return!!e._processing},v.getPreviewUrl=function(e){return e.val?y(e.val,e.mime,v.logger):null},v.getEntitySize=function(e){return e.size?e.size:e.val?.75*e.val.length|0:0},v.getEntityMimeType=function(e){return e.mime||"text/plain"},v.tagName=function(e){return e?_[e]?_[e].name:"_UNKN":void 0},v.attrValue=function(e,t){if(t&&w[e])return w[e].props(t)},v.getContentType=function(){return"text/x-drafty"},h.exports=v,h=h.exports;var N={};let O;Object.defineProperty(N,"__esModule",{value:!0}),N.default=void 0,N.default=class{constructor(e,t){this._tinode=e,this._version=t,this._apiKey=e._apiKey,this._authToken=e.getAuthToken(),this._reqId=e.getNextUniqueId(),this.xhr=new O,this.toResolve=null,this.toReject=null,this.onProgress=null,this.onSuccess=null,this.onFailure=null}uploadWithBaseUrl(e,t,r,i,o,s){if(!this._authToken)throw new Error("Must authenticate first");const a=this;let c="/v".concat(this._version,"/file/u/");if(e){let t=e;if(t.endsWith("/")&&(t=t.slice(0,-1)),!t.startsWith("http://")&&!t.startsWith("https://"))throw new Error("Invalid base URL '".concat(e,"'"));c=t+c}this.xhr.open("POST",c,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("X-Tinode-Auth","Token ".concat(this._authToken.token));const u=new Promise((e,t)=>{this.toResolve=e,this.toReject=t});this.onProgress=i,this.onSuccess=o,this.onFailure=s,this.xhr.upload.onprogress=e=>{e.lengthComputable&&a.onProgress&&a.onProgress(e.loaded/e.total)},this.xhr.onload=function(){let e;try{e=JSON.parse(this.response,n.jsonParseHelper)}catch(t){a._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.response),e={ctrl:{code:this.status,text:this.statusText}}}this.status>=200&&this.status<300?(a.toResolve&&a.toResolve(e.ctrl.params.url),a.onSuccess&&a.onSuccess(e.ctrl)):this.status>=400?(a.toReject&&a.toReject(new Error("".concat(e.ctrl.text," (").concat(e.ctrl.code,")"))),a.onFailure&&a.onFailure(e.ctrl)):a._tinode.logger("ERROR: Unexpected server response status",this.status,this.response)},this.xhr.onerror=function(e){a.toReject&&a.toReject(new Error("failed")),a.onFailure&&a.onFailure(null)},this.xhr.onabort=function(e){a.toReject&&a.toReject(new Error("upload cancelled by user")),a.onFailure&&a.onFailure(null)};try{const e=new FormData;e.append("file",t),e.set("id",this._reqId),r&&e.set("topic",r),this.xhr.send(e)}catch(l){this.toReject&&this.toReject(l),this.onFailure&&this.onFailure(null)}return u}upload(e,t,n,r,i){const o=(this._tinode._secure?"https://":"http://")+this._tinode._host;return this.uploadWithBaseUrl(o,e,t,n,r,i)}download(e,t,r,i,o){if(!Tinode.isRelativeURL(e))return void(o&&o("The URL '".concat(e,"' must be relative, not absolute")));if(!this._authToken)return void(o&&o("Must authenticate first"));const s=this;this.xhr.open("GET",e,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("X-Tinode-Auth","Token "+this._authToken.token),this.xhr.responseType="blob",this.onProgress=i,this.xhr.onprogress=function(e){s.onProgress&&s.onProgress(e.loaded)};const a=new Promise((e,t)=>{this.toResolve=e,this.toReject=t});this.xhr.onload=function(){if(200==this.status){const e=document.createElement("a");e.href=window.URL.createObjectURL(new Blob([this.response],{type:r})),e.style.display="none",e.setAttribute("download",t),document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(e.href),s.toResolve&&s.toResolve()}else if(this.status>=400&&s.toReject){const e=new FileReader;e.onload=function(){try{const e=JSON.parse(this.result,n.jsonParseHelper);s.toReject(new Error("".concat(e.ctrl.text," (").concat(e.ctrl.code,")")))}catch(e){s._tinode.logger("ERROR: Invalid server response in LargeFileHelper",this.result),s.toReject(e)}},e.readAsText(this.response)}},this.xhr.onerror=function(e){s.toReject&&s.toReject(new Error("failed"))},this.xhr.onabort=function(){s.toReject&&s.toReject(null)};try{this.xhr.send()}catch(c){this.toReject&&this.toReject(c)}return a}cancel(){this.xhr&&this.xhr.readyState<4&&this.xhr.abort()}getId(){return this._reqId}static setNetworkProvider(e){O=e}};var I={};return function(t){(function(){"use strict";Object.defineProperty(I,"__esModule",{value:!0}),I.default=void 0;var r,o=(r=e)&&r.__esModule?r:{default:r},s=f(i),a=f(l),c=f(h),u=f(N);function d(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(d=function(e){return e?n:t})(e)}function f(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=d(t);if(n&&n.has(e))return n.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(r,o,s):r[o]=e[o]}return r.default=e,n&&n.set(e,r),r}let p,g,m;function _(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})))}function y(e,t){return"string"==typeof t&&t.length>128?"<"+t.length+", bytes: "+t.substring(0,12)+"..."+t.substring(t.length-12)+">":function(e,t){if(t instanceof Date)t=function(e){if(!function(e){return e instanceof Date&&!isNaN(e)&&0!=e.getTime()}(e))return;const t=function(e,t){return"0".repeat((t=t||2)-(""+e).length)+e},n=e.getUTCMilliseconds();return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+(n?"."+t(n,3):"")+"Z"}(t);else if(t instanceof o.default)t=t.jsonHelper();else if(null==t||!1===t||Array.isArray(t)&&0==t.length||"object"==typeof t&&0==Object.keys(t).length)return;return t}(0,t)}"undefined"!=typeof WebSocket&&(p=WebSocket),"undefined"!=typeof XMLHttpRequest&&(g=XMLHttpRequest),"undefined"!=typeof indexedDB&&(m=indexedDB),function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";"undefined"==typeof btoa&&(t.btoa=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=t,r="";for(let i,o=0,s=0,a=e;n.charAt(0|s)||(a="=",s%1);r+=a.charAt(63&o>>8-s%1*8)){if((i=n.charCodeAt(s+=.75))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");o=o<<8|i}return r}),"undefined"==typeof atob&&(t.atob=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=t.replace(/=+$/,""),r="";if(n.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i,o=0,s=0,a=0;i=n.charAt(a++);~i&&(s=o%4?64*s+i:i,o++%4)?r+=String.fromCharCode(255&s>>(-2*o&6)):0)i=e.indexOf(i);return r}),"undefined"==typeof window&&(t.window={WebSocket:p,XMLHttpRequest:g,indexedDB:m,URL:{createObjectURL:function(){throw new Error("Unable to use URL.createObjectURL in a non-browser application")}}}),(0,s.setNetworkProviders)(p,g),(0,u.setNetworkProvider)(g),(0,a.setDatabaseProvider)(m)}();class b{constructor(e,t){var r=this;this._host=e.host,this._secure=e.secure,this._appName=e.appName||"Undefined",this._apiKey=e.apiKey,this._browser="",this._platform=e.platform||"web",this._hwos="undefined",this._humanLanguage="xx","undefined"!=typeof navigator&&(this._browser=function(e,t){e=e||"";let n,r="";/reactnative/i.test(t)&&(r="ReactNative; ");let i=(e=e.replace(" (KHTML, like Gecko)","")).match(/(AppleWebKit\/[.\d]+)/i);if(i){const t=["edg","chrome","safari","mobile","version"];let r,o=e.substr(i.index+i[0].length).split(" "),s=[];for(let e=0;e<o.length;e++){let n=/([\w.]+)[\/]([\.\d]+)/.exec(o[e]);n&&(s.push([n[1],n[2],t.findIndex(e=>n[1].toLowerCase().startsWith(e))]),"Version"==n[1]&&(r=n[2]))}s.sort((e,t)=>e[2]-t[2]),s.length>0?(s[0][0].toLowerCase().startsWith("edg")?s[0][0]="Edge":"OPR"==s[0][0]?s[0][0]="Opera":"Safari"==s[0][0]&&r&&(s[0][1]=r),n=s[0][0]+"/"+s[0][1]):n=i[1]}else n=/firefox/i.test(e)?(i=/Firefox\/([.\d]+)/g.exec(e))?"Firefox/"+i[1]:"Firefox/?":(i=/([\w.]+)\/([.\d]+)/.exec(e))?i[1]+"/"+i[2]:(i=e.split(" "))[0];if((i=n.split("/")).length>1){const e=i[1].split("."),t=e[1]?"."+e[1].substr(0,2):"";n="".concat(i[0],"/").concat(e[0]).concat(t)}return r+n}(navigator.userAgent,navigator.product),this._hwos=navigator.platform,this._humanLanguage=navigator.language||"en-US"),this._loggingEnabled=!1,this._trimLongStrings=!1,this._myUID=null,this._authenticated=!1,this._login=null,this._authToken=null,this._inPacketCount=0,this._messageId=Math.floor(65535*Math.random()+65535),this._serverInfo=null,this._deviceToken=null,this._pendingPromises={},this._expirePromises=null,this.logger=function(e){if(r._loggingEnabled){const r=new Date,o=("0"+r.getUTCHours()).slice(-2)+":"+("0"+r.getUTCMinutes()).slice(-2)+":"+("0"+r.getUTCSeconds()).slice(-2)+"."+("00"+r.getUTCMilliseconds()).slice(-3);for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];console.log("["+o+"]",e,n.join(" "))}},s.logger=(this.logger,function(){throw new Error('"logger" is read-only.')}()),c.logger=(this.logger,function(){throw new Error('"_logger" is read-only.')}()),"lp"!=e.transport&&"ws"!=e.transport&&(e.transport=function(){if("object"==typeof window){if(window.WebSocket)return"ws";if(window.XMLHttpRequest)return"lp"}return null}()),this._connection=new s.default(e,PROTOCOL_VERSION,!0),this._cache={};const i=this.cachePut=(e,t,n)=>{this._cache[e+":"+t]=n},o=this.cacheGet=(e,t)=>this._cache[e+":"+t],u=this.cacheDel=(e,t)=>{delete this._cache[e+":"+t]},l=this.cacheMap=(e,t,n)=>{const r=e?e+":":void 0;for(let i in this._cache)if((!r||0==i.indexOf(r))&&t.call(n,this._cache[i],i))break};if(this.attachCacheToTopic=e=>{e._tinode=this,e._cacheGetUser=e=>{const t=o("user",e);if(t)return{user:e,public:(0,n.mergeObj)({},t)}},e._cachePutUser=(e,t)=>i("user",e,(0,n.mergeObj)({},t.public)),e._cacheDelUser=e=>u("user",e),e._cachePutSelf=()=>i("topic",e.name,e),e._cacheDelSelf=()=>u("topic",e.name)},this._persist=e.persist,this._db=(0,a.default)(e=>{this.logger("DB",e)},this.logger),this._persist){const e=[];this._db.initDatabase().then(()=>this._db.mapTopics(t=>{let n=this.cacheGet("topic",t.name);n||(n=t.name==TOPIC_ME?new TopicMe:t.name==TOPIC_FND?new TopicFnd:new Topic(t.name),this._db.deserializeTopic(n,t),this.attachCacheToTopic(n),n._cachePutSelf(),e.push(n._loadMessages(this._db)))})).then(()=>this._db.mapUsers(e=>i("user",e.uid,(0,n.mergeObj)({},e.public)))).then(()=>Promise.all(e)).then(()=>{t&&t(),this.logger("Persistent cache initialized.")})}else this._db.deleteDatabase().then(()=>{t&&t()});const d=(e,t,n,r)=>{const i=this._pendingPromises[e];i&&(delete this._pendingPromises[e],t>=200&&t<400?i.resolve&&i.resolve(n):i.reject&&i.reject(new Error("".concat(r," (").concat(t,")"))))},h=e=>{let t=null;return e&&(t=new Promise((t,n)=>{this._pendingPromises[e]={resolve:t,reject:n,ts:new Date}})),t},f=this.getNextUniqueId=()=>0!=this._messageId?""+this._messageId++:void 0,p=()=>this._appName+" ("+(this._browser?this._browser+"; ":"")+this._hwos+"); "+LIBRARY;this.initPacket=(e,t)=>{switch(e){case"hi":return{hi:{id:f(),ver:VERSION,ua:p(),dev:this._deviceToken,lang:this._humanLanguage,platf:this._platform}};case"acc":return{acc:{id:f(),user:null,scheme:null,secret:null,login:!1,tags:null,desc:{},cred:{}}};case"login":return{login:{id:f(),scheme:null,secret:null}};case"sub":return{sub:{id:f(),topic:t,set:{},get:{}}};case"leave":return{leave:{id:f(),topic:t,unsub:!1}};case"pub":return{pub:{id:f(),topic:t,noecho:!1,head:null,content:{}}};case"get":return{get:{id:f(),topic:t,what:null,desc:{},sub:{},data:{}}};case"set":return{set:{id:f(),topic:t,desc:{},sub:{},tags:[]}};case"del":return{del:{id:f(),topic:t,what:null,delseq:null,user:null,hard:!1}};case"note":return{note:{topic:t,what:null,seq:void 0}};default:throw new Error("Unknown packet type requested: ".concat(e))}},this.send=(e,t)=>{let r;t&&(r=h(t)),e=(0,n.simplify)(e);let i=JSON.stringify(e);this.logger("out: "+(this._trimLongStrings?JSON.stringify(e,y):i));try{this._connection.sendText(i)}catch(o){if(!t)throw o;d(t,s.NETWORK_ERROR,null,o.message)}return r},this.loginSuccessful=e=>e.params&&e.params.user?(this._myUID=e.params.user,this._authenticated=e&&e.code>=200&&e.code<300,e.params&&e.params.token&&e.params.expires?this._authToken={token:e.params.token,expires:e.params.expires}:this._authToken=null,this.onLogin&&this.onLogin(e.code,e.text),e):e,this._connection.onMessage=e=>{if(!e)return;if(this._inPacketCount++,this.onRawMessage&&this.onRawMessage(e),"0"===e)return void(this.onNetworkProbe&&this.onNetworkProbe());let t=JSON.parse(e,n.jsonParseHelper);t?(this.logger("in: "+(this._trimLongStrings?JSON.stringify(t,y):e)),this.onMessage&&this.onMessage(t),t.ctrl?(this.onCtrlMessage&&this.onCtrlMessage(t.ctrl),t.ctrl.id&&d(t.ctrl.id,t.ctrl.code,t.ctrl,t.ctrl.text),setTimeout(()=>{if(205==t.ctrl.code&&"evicted"==t.ctrl.text){const e=o("topic",t.ctrl.topic);e&&(e._resetSub(),t.ctrl.params&&t.ctrl.params.unsub&&e._gone())}else if(t.ctrl.code<300&&t.ctrl.params)if("data"==t.ctrl.params.what){const e=o("topic",t.ctrl.topic);e&&e._allMessagesReceived(t.ctrl.params.count)}else if("sub"==t.ctrl.params.what){const e=o("topic",t.ctrl.topic);e&&e._processMetaSub([])}},0)):setTimeout(()=>{if(t.meta){const e=o("topic",t.meta.topic);e&&e._routeMeta(t.meta),t.meta.id&&d(t.meta.id,200,t.meta,"META"),this.onMetaMessage&&this.onMetaMessage(t.meta)}else if(t.data){const e=o("topic",t.data.topic);e&&e._routeData(t.data),this.onDataMessage&&this.onDataMessage(t.data)}else if(t.pres){const e=o("topic",t.pres.topic);e&&e._routePres(t.pres),this.onPresMessage&&this.onPresMessage(t.pres)}else if(t.info){const e=o("topic",t.info.topic);e&&e._routeInfo(t.info),this.onInfoMessage&&this.onInfoMessage(t.info)}else this.logger("ERROR: Unknown packet received.")},0)):(this.logger("in: "+e),this.logger("ERROR: failed to parse data"))},this._connection.onOpen=()=>{this._expirePromises||(this._expirePromises=setInterval(()=>{const e=new Error("Timeout (504)"),t=new Date((new Date).getTime()-EXPIRE_PROMISES_TIMEOUT);for(let n in this._pendingPromises){let r=this._pendingPromises[n];r&&r.ts<t&&(this.logger("Promise expired",n),delete this._pendingPromises[n],r.reject&&r.reject(e))}},EXPIRE_PROMISES_PERIOD)),this.hello()},this._connection.onAutoreconnectIteration=(e,t)=>{this.onAutoreconnectIteration&&this.onAutoreconnectIteration(e,t)},this._connection.onDisconnect=(e,t)=>{this._inPacketCount=0,this._serverInfo=null,this._authenticated=!1,this._expirePromises&&(clearInterval(this._expirePromises),this._expirePromises=null),l("topic",(e,t)=>{e._resetSub()});for(let n in this._pendingPromises){const t=this._pendingPromises[n];t&&t.reject&&t.reject(e)}this._pendingPromises={},this.onDisconnect&&this.onDisconnect(e)}}static credential(e,t,n,r){return"object"==typeof e&&({val:t,params:n,resp:r,meth:e}=e),e&&(t||r)?[{meth:e,val:t,resp:r,params:n}]:null}static topicType(e){return{me:"me",fnd:"fnd",grp:"grp",new:"grp",nch:"grp",chn:"grp",usr:"p2p",sys:"sys"}["string"==typeof e?e.substring(0,3):"xxx"]}static isMeTopicName(e){return"me"==b.topicType(e)}static isGroupTopicName(e){return"grp"==b.topicType(e)}static isP2PTopicName(e){return"p2p"==b.topicType(e)}static isCommTopicName(e){return b.isP2PTopicName(e)||b.isGroupTopicName(e)}static isNewGroupTopicName(e){return"string"==typeof e&&(e.substring(0,3)==TOPIC_NEW||e.substring(0,3)==TOPIC_NEW_CHAN)}static isChannelTopicName(e){return"string"==typeof e&&(e.substring(0,3)==TOPIC_CHAN||e.substring(0,3)==TOPIC_NEW_CHAN)}static getVersion(){return VERSION}static setNetworkProviders(e,t){p=e,g=t,(0,s.setNetworkProviders)(p,g),(0,u.setNetworkProvider)(g)}static setDatabaseProvider(e){m=e,(0,a.setDatabaseProvider)(m)}static getLibrary(){return LIBRARY}static isNullValue(e){return e===b.DEL_CHAR}static isRelativeURL(e){return!/^\s*([a-z][a-z0-9+.-]*:|\/\/)/im.test(e)}}I.default=b,b.MESSAGE_STATUS_NONE=MESSAGE_STATUS_NONE,b.MESSAGE_STATUS_QUEUED=MESSAGE_STATUS_QUEUED,b.MESSAGE_STATUS_SENDING=MESSAGE_STATUS_SENDING,b.MESSAGE_STATUS_FAILED=MESSAGE_STATUS_FAILED,b.MESSAGE_STATUS_SENT=MESSAGE_STATUS_SENT,b.MESSAGE_STATUS_RECEIVED=MESSAGE_STATUS_RECEIVED,b.MESSAGE_STATUS_READ=MESSAGE_STATUS_READ,b.MESSAGE_STATUS_TO_ME=MESSAGE_STATUS_TO_ME,b.MESSAGE_STATUS_DEL_RANGE=MESSAGE_STATUS_DEL_RANGE,b.DEL_CHAR="\u2421",b.MAX_MESSAGE_SIZE="maxMessageSize",b.MAX_SUBSCRIBER_COUNT="maxSubscriberCount",b.MAX_TAG_COUNT="maxTagCount",b.MAX_FILE_UPLOAD_SIZE="maxFileUploadSize",b.prototype={connect:function(e){return this._connection.connect(e)},reconnect:function(e){this._connection.reconnect(e)},disconnect:function(){this._connection.disconnect()},clearStorage:function(){return this._db.isReady()?this._db.deleteDatabase():Promise.resolve()},initStorage:function(){return this._db.isReady()?Promise.resolve():this._db.initDatabase()},networkProbe:function(){this._connection.probe()},isConnected:function(){return this._connection.isConnected()},isAuthenticated:function(){return this._authenticated},authorizeURL:function(e){if("string"!=typeof e)return e;if(b.isRelativeURL(e)){const t="scheme://host/",n=new URL(e,t);this._apiKey&&n.searchParams.append("apikey",this._apiKey),this._authToken&&this._authToken.token&&(n.searchParams.append("auth","token"),n.searchParams.append("secret",this._authToken.token)),e=n.toString().substring(t.length-1)}return e},account:function(e,t,n,r,i){const o=this.initPacket("acc");return o.acc.user=e,o.acc.scheme=t,o.acc.secret=n,o.acc.login=r,i&&(o.acc.desc.defacs=i.defacs,o.acc.desc.public=i.public,o.acc.desc.private=i.private,o.acc.desc.trusted=i.trusted,o.acc.tags=i.tags,o.acc.cred=i.cred,o.acc.token=i.token,Array.isArray(i.attachments)&&i.attachments.length>0&&(o.extra={attachments:i.attachments.filter(e=>b.isRelativeURL(e))})),this.send(o,o.acc.id)},createAccount:function(e,t,n,r){let i=this.account(USER_NEW,e,t,n,r);return n&&(i=i.then(e=>this.loginSuccessful(e))),i},createAccountBasic:function(e,t,n){return e=e||"",t=t||"",this.createAccount("basic",_(e+":"+t),!0,n)},updateAccountBasic:function(e,t,n,r){return t=t||"",n=n||"",this.account(e,"basic",_(t+":"+n),!1,r)},hello:function(){const e=this.initPacket("hi");return this.send(e,e.hi.id).then(e=>(this._connection.backoffReset(),e.params&&(this._serverInfo=e.params),this.onConnect&&this.onConnect(),e)).catch(e=>{this._connection.reconnect(!0),this.onDisconnect&&this.onDisconnect(e)})},setDeviceToken:function(e){let t=!1;return(e=e||null)!=this._deviceToken&&(this._deviceToken=e,this.isConnected()&&this.isAuthenticated()&&(this.send({hi:{dev:e||b.DEL_CHAR}}),t=!0)),t},login:function(e,t,n){const r=this.initPacket("login");return r.login.scheme=e,r.login.secret=t,r.login.cred=n,this.send(r,r.login.id).then(e=>this.loginSuccessful(e))},loginBasic:function(e,t,n){return this.login("basic",_(e+":"+t),n).then(t=>(this._login=e,t))},loginToken:function(e,t){return this.login("token",e,t)},requestResetAuthSecret:function(e,t,n){return this.login("reset",_(e+":"+t+":"+n))},getAuthToken:function(){return this._authToken&&this._authToken.expires.getTime()>Date.now()?this._authToken:(this._authToken=null,null)},setAuthToken:function(e){this._authToken=e},subscribe:function(e,t,n){const r=this.initPacket("sub",e);if(e||(e=TOPIC_NEW),r.sub.get=t,n){if(n.sub&&(r.sub.set.sub=n.sub),n.desc){const t=n.desc;b.isNewGroupTopicName(e)?r.sub.set.desc=t:b.isP2PTopicName(e)&&t.defacs&&(r.sub.set.desc={defacs:t.defacs})}Array.isArray(n.attachments)&&n.attachments.length>0&&(r.extra={attachments:n.attachments.filter(e=>b.isRelativeURL(e))}),n.tags&&(r.sub.set.tags=n.tags)}return this.send(r,r.sub.id)},leave:function(e,t){const n=this.initPacket("leave",e);return n.leave.unsub=t,this.send(n,n.leave.id)},createMessage:function(e,t,n){const r=this.initPacket("pub",e);let i="string"==typeof t?c.default.parse(t):t;return i&&!c.default.isPlainText(i)&&(r.pub.head={mime:c.default.getContentType()},t=i),r.pub.noecho=n,r.pub.content=t,r.pub},publish:function(e,t,n){return this.publishMessage(this.createMessage(e,t,n))},publishMessage:function(e,t){(e=Object.assign({},e)).seq=void 0,e.from=void 0,e.ts=void 0;const n={pub:e};return t&&(n.extra={attachments:t.filter(e=>b.isRelativeURL(e))}),this.send(n,e.id)},oobNotification:function(e,t,n){const r=this.cacheGet("topic",e);r&&(r._updateReceived(t,n),this.getMeTopic()._refreshContact("msg",r))},getMeta:function(e,t){const r=this.initPacket("get",e);return r.get=(0,n.mergeObj)(r.get,t),this.send(r,r.get.id)},setMeta:function(e,t){const n=this.initPacket("set",e),r=[];return t&&(["desc","sub","tags","cred"].forEach((function(e){t.hasOwnProperty(e)&&(r.push(e),n.set[e]=t[e])})),Array.isArray(t.attachments)&&t.attachments.length>0&&(n.extra={attachments:t.attachments.filter(e=>b.isRelativeURL(e))})),0==r.length?Promise.reject(new Error("Invalid {set} parameters")):this.send(n,n.set.id)},delMessages:function(e,t,n){const r=this.initPacket("del",e);return r.del.what="msg",r.del.delseq=t,r.del.hard=n,this.send(r,r.del.id)},delTopic:function(e,t){const n=this.initPacket("del",e);return n.del.what="topic",n.del.hard=t,this.send(n,n.del.id)},delSubscription:function(e,t){const n=this.initPacket("del",e);return n.del.what="sub",n.del.user=t,this.send(n,n.del.id)},delCredential:function(e,t){const n=this.initPacket("del",TOPIC_ME);return n.del.what="cred",n.del.cred={meth:e,val:t},this.send(n,n.del.id)},delCurrentUser:function(e){const t=this.initPacket("del",null);return t.del.what="user",t.del.hard=e,this.send(t,t.del.id).then(e=>{this._myUID=null})},note:function(e,t,n){if(n<=0||n>=LOCAL_SEQID)throw new Error("Invalid message id ".concat(n));const r=this.initPacket("note",e);r.note.what=t,r.note.seq=n,this.send(r)},noteKeyPress:function(e){const t=this.initPacket("note",e);t.note.what="kp",this.send(t)},getTopic:function(e){let t=this.cacheGet("topic",e);return!t&&e&&(t=e==TOPIC_ME?new TopicMe:e==TOPIC_FND?new TopicFnd:new Topic(e),this.attachCacheToTopic(t),t._cachePutSelf()),t},isTopicCached:function(e){return!!this.cacheGet("topic",e)},newGroupTopicName:function(e){return(e?TOPIC_NEW_CHAN:TOPIC_NEW)+this.getNextUniqueId()},getMeTopic:function(){return this.getTopic(TOPIC_ME)},getFndTopic:function(){return this.getTopic(TOPIC_FND)},getLargeFileHelper:function(){return new u.default(this,PROTOCOL_VERSION)},getCurrentUserID:function(){return this._myUID},isMe:function(e){return this._myUID===e},getCurrentLogin:function(){return this._login},getServerInfo:function(){return this._serverInfo},getServerLimit:function(e,t){return(this._serverInfo?this._serverInfo[e]:null)||t},enableLogging:function(e,t){this._loggingEnabled=e,this._trimLongStrings=e&&t},setHumanLanguage:function(e){e&&(this._humanLanguage=e)},isTopicOnline:function(e){const t=this.cacheGet("topic",e);return t&&t.online},getTopicAccessMode:function(e){const t=this.cacheGet("topic",e);return t?t.acs:null},wantAkn:function(e){this._messageId=e?Math.floor(16777215*Math.random()+16777215):0},onWebsocketOpen:void 0,onConnect:void 0,onDisconnect:void 0,onLogin:void 0,onCtrlMessage:void 0,onDataMessage:void 0,onPresMessage:void 0,onMessage:void 0,onRawMessage:void 0,onNetworkProbe:void 0,onAutoreconnectIteration:void 0}}).call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{}),I}));